<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Calculateur d'analyse co√ªts-b√©n√©fices pour les compteurs d'eau intelligents au Qu√©bec">
    <title>Analyse Co√ªts-B√©n√©fices ‚Äî Compteurs d'Eau Intelligents</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="translations.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f4c75;
            --primary-light: #3282b8;
            --primary-dark: #0b3d5e;
            --secondary: #00b4d8;
            --accent: #48cae4;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --bg: #f0f4f8;
            --bg-dark: #e2e8f0;
            --card: #ffffff;
            --text: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
            --radius: 16px;
            --radius-sm: 8px;
            --transition: 200ms ease;
            --transition-fast: 150ms ease;
            --hover-scale: 1.02;
            --hover-lift: translateY(-2px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Global interactive elements */
        button, .btn, .card[onclick], .preset-btn, .toggle, .tab-btn,
        [role="button"], summary, label[for], .clickable {
            cursor: pointer;
        }

        /* Lucide icons styling */
        .lucide {
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
            stroke-width: 2;
        }
        .lucide-sm { width: 16px; height: 16px; }
        .lucide-md { width: 20px; height: 20px; }
        .lucide-lg { width: 24px; height: 24px; }
        .lucide-xl { width: 32px; height: 32px; }

        /* Toggle chevron animations */
        .toggle-chevron {
            display: inline-flex;
            transition: transform var(--transition);
        }
        .toggle-chevron.open { transform: rotate(90deg); }
        .toggle-chevron svg { width: 18px; height: 18px; }

        /* Spin animation for loader */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            touch-action: manipulation; /* Disable 300ms tap delay on mobile */
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 50%, var(--secondary) 100%);
            color: white;
            padding: 2rem 3rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-wrap: balance;
        }

        .header-subtitle {
            opacity: 0.9;
            font-size: 0.95rem;
            margin-top: 0.25rem;
            font-weight: 400;
        }

        .header-badge {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .api-status {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .api-status.connected {
            background: rgba(6, 214, 160, 0.2);
            color: #06d6a0;
        }

        .api-status.connected::before { background: #06d6a0; }

        .api-status.disconnected {
            background: rgba(239, 71, 111, 0.2);
            color: #ef476f;
        }

        .api-status.disconnected::before { background: #ef476f; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Layout */
        .container {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1900px;
            margin: 0 auto;
        }

        @media (max-width: 1400px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { order: 2; }
            .main { order: 1; }
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: box-shadow var(--transition);
        }

        .card:hover { box-shadow: var(--shadow-lg); }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .card-icon svg { width: 22px; height: 22px; stroke-width: 2; }

        .card-icon.blue { background: linear-gradient(135deg, #e0f2fe, #bae6fd); color: #0369a1; }
        .card-icon.green { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #047857; }
        .card-icon.purple { background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #6d28d9; }
        .card-icon.orange { background: linear-gradient(135deg, #ffedd5, #fed7aa); color: #c2410c; }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            letter-spacing: -0.2px;
            text-wrap: balance;
        }

        .card-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.1rem;
            text-wrap: balance;
        }

        /* Presets */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .preset-btn {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            background: var(--card);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            text-align: left;
        }

        .preset-btn:hover {
            border-color: var(--primary-light);
            background: #f8fafc;
        }

        .preset-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-color: transparent;
        }

        .preset-btn .city { display: block; font-weight: 600; }
        .preset-btn .info { font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem; }

        /* Input Groups */
        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-group:last-child { margin-bottom: 0; }

        .input-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .input-group .value {
            font-weight: 700;
            color: var(--primary);
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Custom Range Slider */
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-dark);
            outline: none;
            -webkit-appearance: none;
            transition: background var(--transition);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(15, 76, 117, 0.3);
            transition: transform var(--transition), box-shadow var(--transition);
            border: 3px solid white;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(15, 76, 117, 0.4);
        }

        input[type="range"]:focus-visible::-webkit-slider-thumb {
            box-shadow: 0 0 0 4px rgba(15, 76, 117, 0.15);
        }

        /* Select */
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: border-color var(--transition), box-shadow var(--transition);
            color: var(--text);
        }

        select:hover { border-color: var(--primary-light); }

        select:focus-visible {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(15, 76, 117, 0.1);
        }

        /* Toggle */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            margin-bottom: 1rem;
        }

        .toggle {
            position: relative;
            width: 56px;
            height: 30px;
            background: var(--bg-dark);
            border-radius: 15px;
            cursor: pointer;
            transition: background var(--transition);
            flex-shrink: 0;
        }

        .toggle.active { background: var(--primary); }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform var(--transition);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle.active::after { transform: translateX(26px); }

        .toggle-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Main Area */
        .main { display: flex; flex-direction: column; gap: 1.5rem; }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
        }

        @media (max-width: 1600px) {
            .metrics-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 900px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .metric-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: transform var(--transition), box-shadow var(--transition);
        }
        .metric-card:hover {
            transform: var(--hover-lift);
            box-shadow: var(--shadow-lg);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--border);
        }

        .metric-card.primary::before {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .metric-card.success::before { background: var(--success); }
        .metric-card.warning::before { background: var(--warning); }
        .metric-card.danger::before { background: var(--danger); }

        /* Subtle glow for positive/negative indicators */
        .metric-card.success:hover {
            box-shadow: var(--shadow-lg), 0 0 20px rgba(6, 214, 160, 0.15);
        }

        .metric-card.danger:hover {
            box-shadow: var(--shadow-lg), 0 0 20px rgba(239, 71, 111, 0.15);
        }

        .metric-card.primary:hover {
            box-shadow: var(--shadow-lg), 0 0 20px rgba(15, 76, 117, 0.15);
        }

        .metric-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.1;
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
            transition: transform var(--transition-fast), opacity var(--transition-fast);
        }

        .metric-value.updating {
            transform: scale(1.05);
            opacity: 0.7;
        }

        .metric-card.primary .metric-value { color: var(--primary); }
        .metric-card.success .metric-value { color: var(--success); }
        .metric-card.danger .metric-value { color: var(--danger); }

        .metric-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--text-muted);
        }

        /* Recommendation Banner */
        .recommendation {
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow);
        }

        .recommendation-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .recommendation-icon svg { width: 26px; height: 26px; stroke-width: 2.5; }

        .recommendation.positive {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 1px solid #6ee7b7;
            color: #065f46;
        }

        .recommendation.positive .recommendation-icon {
            background: #10b981;
            color: white;
        }

        .recommendation.negative {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid #fca5a5;
            color: #991b1b;
        }

        .recommendation.negative .recommendation-icon {
            background: #ef4444;
            color: white;
        }

        .recommendation.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
            color: #92400e;
        }

        .recommendation.warning .recommendation-icon {
            background: #f59e0b;
            color: white;
        }

        .recommendation-text strong { font-weight: 700; }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        .chart-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: box-shadow var(--transition), border-color var(--transition);
        }

        .chart-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .chart-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Chart skeleton loading */
        .chart-skeleton {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, var(--bg) 25%, var(--bg-dark) 50%, var(--bg) 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-skeleton::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .chart-wrapper canvas {
            transition: opacity var(--transition);
        }

        .chart-wrapper.loading canvas {
            opacity: 0.3;
        }

        /* Detail Table */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .detail-grid { grid-template-columns: 1fr; }
        }

        .breakdown-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.875rem;
        }

        .breakdown-table th,
        .breakdown-table td {
            padding: 0.875rem 1rem;
            text-align: left;
        }

        .breakdown-table th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        .breakdown-table th:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
        .breakdown-table th:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }

        .breakdown-table td {
            border-bottom: 1px solid var(--border);
        }

        .breakdown-table td:last-child {
            text-align: right;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-weight: 600;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }

        .breakdown-table tr:last-child td {
            border-bottom: none;
            background: var(--bg);
            font-weight: 700;
        }

        .breakdown-table tr:last-child td:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
        .breakdown-table tr:last-child td:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }

        /* Row hover highlighting */
        .breakdown-table tbody tr {
            transition: background-color var(--transition-fast);
        }

        .breakdown-table tbody tr:not(:last-child):hover {
            background-color: var(--bg);
        }

        .breakdown-table tbody tr:not(:last-child):hover td {
            color: var(--primary-dark);
        }

        /* Loading Bar */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 100%;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform var(--transition);
            z-index: 1000;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading.active { transform: scaleX(1); }

        /* Loading Overlay (initial) */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.4s, visibility 0.4s;
        }
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .loading-content {
            text-align: center;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .loading-subtext {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .loading-overlay.error .loading-spinner {
            border-top-color: #ef476f;
            animation: none;
        }
        .loading-overlay.error .loading-text {
            color: #ef476f;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            background: var(--card);
            margin-top: 1rem;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover { text-decoration: underline; }

        .footer-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-top: 1rem;
            opacity: 0.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Advanced Parameters Section */
        .advanced-params {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .advanced-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: background var(--transition);
        }

        .advanced-header:hover {
            background: var(--bg-dark);
        }

        .chevron {
            transition: transform var(--transition);
            font-size: 0.7rem;
        }

        .chevron.open {
            transform: rotate(180deg);
        }

        .advanced-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition);
        }

        .advanced-content.open {
            max-height: 1000px;
        }

        .param-section {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(15, 76, 117, 0.03);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--primary-light);
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .param-section .input-group {
            margin-bottom: 0.75rem;
        }

        .param-section .input-group:last-child {
            margin-bottom: 0;
        }

        /* Info badge for leak params */
        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: #0369a1;
            margin-top: 0.5rem;
        }

        /* Scenario Badge */
        .scenario-badge {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .scenario-icon {
            font-size: 2rem;
        }

        .scenario-info {
            flex: 1;
        }

        .scenario-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scenario-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .scenario-details {
            display: flex;
            gap: 0.5rem;
        }

        .tag {
            padding: 0.375rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tag-persistance {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .tag-fuites {
            background: #fef3c7;
            color: #b45309;
        }

        .tag-mode {
            background: #d1fae5;
            color: #047857;
        }

        .actions-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0 0 1rem 0;
        }

        .btn {
            padding: 0.5rem 0.9rem;
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn:hover {
            border-color: var(--primary-light);
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .help-text {
            color: #666;
            font-size: 11px;
            margin-top: 4px;
            display: block;
        }

        /* Signal-prix indicator box */
        .signal-prix-box {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 1px solid #fcd34d;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
        }

        .signal-prix-box.active {
            background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
            border-color: #6ee7b7;
        }

        .signal-prix-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .signal-prix-box.active .signal-prix-indicator {
            color: #047857;
        }

        .signal-prix-rate {
            margin-left: auto;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .signal-prix-box .help-text {
            margin-top: 0.5rem;
            line-height: 1.5;
        }

        /* Monte Carlo Stats Grid */
        .mc-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 1200px) {
            .mc-stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .mc-stat-card {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 1px solid #c4b5fd;
            border-radius: var(--radius-sm);
            padding: 1rem;
            text-align: center;
        }

        .mc-stat-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6d28d9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .mc-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #5b21b6;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        /* Monte Carlo Button */
        .btn-mc {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-mc:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .btn-mc:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-mc.loading {
            background: #a78bfa;
        }

        /* Map Picker Button */
        .map-picker-btn {
            width: 100%;
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all var(--transition);
        }

        .map-picker-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }

        .map-picker-icon {
            font-size: 1.2rem;
        }

        /* Map Modal */
        .map-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .map-modal-overlay.active {
            display: flex;
        }

        .map-modal {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            max-height: 800px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .map-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }

        .map-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .map-modal-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .map-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: all var(--transition);
        }

        .map-modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .map-modal-body {
            flex: 1;
            position: relative;
        }

        .map-modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .map-modal-footer {
            padding: 0.75rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Selected municipality indicator */
        .selected-municipality {
            display: none;
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: #047857;
        }

        .selected-municipality.active {
            display: block;
        }

        .selected-municipality strong {
            font-weight: 600;
        }

        /* =========================
           ACCESSIBILIT√â (a11y)
           ========================= */

        /* Skip link */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            z-index: 10000;
            text-decoration: none;
            transition: top var(--transition);
        }

        .skip-link:focus {
            top: 10px;
            outline: 3px solid var(--warning);
            outline-offset: 2px;
        }

        /* Focus visible am√©lior√© */
        :focus-visible {
            outline: 3px solid var(--secondary);
            outline-offset: 2px;
        }

        button:focus-visible,
        .btn:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid var(--primary-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(15, 76, 117, 0.2);
        }

        /* Contraste am√©lior√© pour texte secondaire */
        .card-subtitle,
        .metric-change,
        small {
            color: #4a5568; /* Ratio 7:1 sur blanc */
        }

        /* Touch-friendly sliders */
        input[type="range"] {
            height: 8px;
            cursor: pointer;
            touch-action: pan-x;
        }

        input[type="range"]::-webkit-slider-thumb {
            width: 24px;
            height: 24px;
            cursor: grab;
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            cursor: grab;
        }

        input[type="range"]:active::-webkit-slider-thumb {
            cursor: grabbing;
        }

        /* =========================
           RESPONSIVE MOBILE
           ========================= */

        @media (max-width: 768px) {
            .header {
                padding: 1rem 1.5rem;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .header-subtitle {
                font-size: 0.8rem;
            }

            .container {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }

            .sidebar {
                width: 100%;
                max-width: 100%;
                order: 2;
            }

            .main {
                width: 100%;
                order: 1;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .metric-card {
                padding: 1rem;
            }

            .metric-value {
                font-size: 1.25rem;
            }

            .chart-card {
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .input-group label {
                font-size: 0.8rem;
            }

            .actions-bar {
                flex-wrap: wrap;
            }

            .btn {
                flex: 1 1 45%;
                min-width: 120px;
            }

            /* Sidebar collapsible */
            .sidebar-toggle {
                display: flex;
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 24px;
                align-items: center;
                justify-content: center;
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                cursor: pointer;
            }

            .sidebar.collapsed {
                display: none;
            }

            /* Charts responsive */
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                flex: 1 1 100%;
            }
        }

        /* Pr√©f√©rence mouvement r√©duit */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Mode sombre (pr√©paration) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1a202c;
                --bg-dark: #2d3748;
                --card: #2d3748;
                --text: #f7fafc;
                --text-secondary: #e2e8f0;
                --text-muted: #a0aec0;
                --border: #4a5568;
            }
        }

        /* Bouton toggle sidebar (cach√© par d√©faut, visible sur mobile) */
        .sidebar-toggle {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Skip link pour accessibilit√© -->
    <a href="#main-content" class="skip-link" data-i18n="skip_link">Aller au contenu principal</a>

    <div class="loading" id="loading" aria-hidden="true"></div>

    <!-- Overlay de chargement initial -->
    <div class="loading-overlay" id="loading-overlay" role="status" aria-live="polite">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" data-i18n="loading.connecting">Connexion au serveur...</div>
            <div class="loading-subtext" data-i18n="loading.init">Initialisation du mod√®le</div>
        </div>
    </div>

    <div class="header">
        <div class="header-content">
            <div>
                <h1 data-i18n="header.title">Analyse Co√ªts-B√©n√©fices</h1>
                <p class="header-subtitle" data-i18n="header.subtitle">Compteurs d'eau intelligents ‚Äî Mod√®le √©conomique v3.11</p>
            </div>
            <div class="header-badge" style="display: flex; align-items: center; gap: 12px;">
                <button id="lang-toggle" onclick="toggleLanguage()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;" aria-label="Changer de langue">FR</button>
                <span class="api-status disconnected" id="api-status" data-i18n="header.api_connecting">Connexion API...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <!-- Presets -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon blue">üèôÔ∏è</div>
                    <div>
                        <div class="card-title" data-i18n="section.municipalities">Municipalit√©s</div>
                        <div class="card-subtitle" data-i18n="section.municipalities_sub">S√©lectionner un profil pr√©d√©fini</div>
                    </div>
                </div>
                <div class="preset-grid">
                    <button class="preset-btn active" onclick="loadPreset('longueuil')">
                        <span class="city">Longueuil</span>
                        <span class="info">116K m√©nages ‚Ä¢ 236 LPCD</span>
                    </button>
                    <button class="preset-btn" onclick="loadPreset('montreal')">
                        <span class="city">Montr√©al</span>
                        <span class="info">750K m√©nages ‚Ä¢ 332 LPCD</span>
                    </button>
                    <button class="preset-btn" onclick="loadPreset('quebec')">
                        <span class="city">Qu√©bec</span>
                        <span class="info">180K m√©nages ‚Ä¢ 280 LPCD</span>
                    </button>
                    <button class="preset-btn" onclick="loadPreset('winnipeg')">
                        <span class="city">Winnipeg</span>
                        <span class="info">221K m√©nages ‚Ä¢ 250 LPCD</span>
                    </button>
                </div>
                <button class="map-picker-btn" onclick="openMapPicker()">
                    <span class="map-picker-icon">üó∫Ô∏è</span>
                    <span class="map-picker-text" data-i18n="section.map_picker">Choisir sur la carte du Qu√©bec</span>
                </button>
                <div class="selected-municipality" id="selected-municipality"></div>
            </div>

            <!-- Project Parameters -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon green"><i data-lucide="bar-chart-2"></i></div>
                    <div>
                        <div class="card-title" data-i18n="section.project">Param√®tres du projet</div>
                        <div class="card-subtitle" data-i18n="section.project_sub">Configuration de base</div>
                    </div>
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.households">Nombre de m√©nages</span> <span class="value" id="val-menages">116 258</span></label>
                    <input type="range" id="nb-menages" min="10000" max="1000000" step="1000" value="116258" oninput="onParamChange()">
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.household_size">Taille du m√©nage (pers.)</span> <span class="value" id="val-taille">2.18</span></label>
                    <input type="range" id="taille-menage" min="1.5" max="4" step="0.01" value="2.18" oninput="onParamChange()">
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.lpcd">Consommation (L/pers/jour)</span> <span class="value" id="val-lpcd">236</span></label>
                    <input type="range" id="lpcd" min="150" max="450" step="1" value="236" oninput="onParamChange()">
                </div>

                <!-- Calibrage automatique -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <button class="btn" style="width: 100%; font-size: 12px;" onclick="openCalibrationModal()">
                        <i data-lucide="trending-up" class="lucide-sm"></i> <span data-i18n="calibration.btn">Calibrer depuis donn√©es</span>
                    </button>
                    <small style="color: #666; font-size: 10px; display: block; margin-top: 6px; text-align: center;" data-i18n="calibration.btn_help">
                        Importer un CSV de consommation mensuelle
                    </small>
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.horizon">Horizon d'analyse (ann√©es)</span> <span class="value" id="val-horizon">20</span></label>
                    <input type="range" id="horizon" min="10" max="30" step="1" value="20" oninput="onParamChange()">
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.discount_rate">Taux d'actualisation (%)</span> <span class="value" id="val-taux">3.0</span></label>
                    <input type="range" id="taux-actualisation" min="1" max="8" step="0.1" value="3" oninput="onParamChange()">
                </div>
            </div>

            <!-- Meter Costs -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon purple"><i data-lucide="droplet"></i></div>
                    <div>
                        <div class="card-title" data-i18n="section.technology">Technologie de comptage</div>
                        <div class="card-subtitle" data-i18n="section.technology_sub">Co√ªts et installation</div>
                    </div>
                </div>

                <div class="input-group">
                    <label data-i18n="param.meter_type">Type de compteur</label>
                    <select id="type-compteur" onchange="onParamChange()">
                        <option value="ami" data-i18n="meter.ami">AMI ‚Äî Intelligent (temps r√©el)</option>
                        <option value="amr" data-i18n="meter.amr">AMR ‚Äî Lecture automatique</option>
                        <option value="manuel" data-i18n="meter.manual">Manuel ‚Äî Relev√© traditionnel</option>
                    </select>
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.meter_cost">Co√ªt unitaire du compteur</span> <span class="value" id="val-cout-compteur">250 $</span></label>
                    <input type="range" id="cout-compteur" min="50" max="600" step="10" value="250" oninput="onParamChange()">
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.install_hours">Heures d'installation</span> <span class="value" id="val-heures">3.0 h</span></label>
                    <input type="range" id="heures-install" min="0.5" max="8" step="0.5" value="3" oninput="onParamChange()">
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.hourly_rate">Taux horaire installation</span> <span class="value" id="val-taux-horaire">125 $/h</span></label>
                    <input type="range" id="taux-horaire" min="75" max="200" step="5" value="125" oninput="onParamChange()">
                </div>

                <div class="input-group" id="cout-reseau-group">
                    <label><span data-i18n="param.network_cost">Infrastructure r√©seau</span> <span class="value" id="val-cout-reseau">50 $/u</span></label>
                    <input type="range" id="cout-reseau" min="0" max="200" step="10" value="50" oninput="onParamChange()">
                </div>

                <div class="input-group" id="cout-infra-fixe-group">
                    <label><span data-i18n="param.fixed_infra">Co√ªt infra fixe (IT, int√©gration)</span> <span class="value" id="val-cout-infra-fixe">0 $</span></label>
                    <input type="range" id="cout-infra-fixe" min="0" max="2000000" step="50000" value="0" oninput="onParamChange()">
                </div>

                <div class="input-group" id="opex-ami-group">
                    <label><span data-i18n="param.opex_ami">OPEX AMI non-tech</span> <span class="value" id="val-opex-ami">15 $/an</span></label>
                    <input type="range" id="opex-ami" min="0" max="50" step="1" value="15" oninput="onParamChange()">
                    <small style="color: #666; font-size: 10px;" data-i18n="param.opex_ami_help">Cyber, logiciels, stockage, t√©l√©com (Bas=10, M√©dian=15, Haut=35)</small>
                </div>
            </div>

            <!-- Behavior & Leaks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon orange"><i data-lucide="settings"></i></div>
                    <div>
                        <div class="card-title" data-i18n="section.behavior">Comportement & Fuites</div>
                        <div class="card-subtitle" data-i18n="section.behavior_sub">Param√®tres d'√©conomies</div>
                    </div>
                </div>

                <div class="input-group">
                    <label><span data-i18n="param.behavior_reduction">R√©duction comportementale</span> <span class="value" id="val-reduction">8.0 %</span></label>
                    <input type="range" id="reduction-comportement" min="0" max="15" step="0.5" value="8" oninput="onParamChange()">
                </div>

                <div class="input-group">
                    <label data-i18n="param.persistence">Sc√©nario de persistance</label>
                    <select id="persistance" onchange="onParamChange()">
                        <option value="optimiste" data-i18n="persistence.optimistic">Optimiste ‚Äî Effet constant (Œ± = 8%)</option>
                        <option value="realiste" selected data-i18n="persistence.realistic">R√©aliste ‚Äî Plateau √† 2.5%</option>
                        <option value="pessimiste" data-i18n="persistence.pessimistic">Pessimiste ‚Äî Fadeout sur 10 ans</option>
                        <option value="ultra" data-i18n="persistence.ultra">Ultra-pessimiste ‚Äî Aucun effet</option>
                    </select>
                </div>

                <div class="input-group">
                    <label data-i18n="param.leak_scenario">Sc√©nario de fuites</label>
                    <select id="scenario-fuites" onchange="onScenarioFuitesChange()">
                        <optgroup label="Avec signal-prix (r√©paration plus probable)" data-i18n="leaks.group_with_price">
                            <option value="standard" data-i18n="leaks.standard">Standard (20%)</option>
                            <option value="quebec" data-i18n="leaks.quebec">Qu√©bec (35%)</option>
                            <option value="deux_stocks" data-i18n="leaks.two_stocks">Qu√©bec diff√©renci√© (2 stocks)</option>
                            <option value="menage" data-i18n="leaks.household">M√©nage (40%)</option>
                            <option value="subvention_50" data-i18n="leaks.subsidy_50">Subvention 50%</option>
                            <option value="ville" data-i18n="leaks.city">Ville (meilleure d√©tection)</option>
                        </optgroup>

                        <optgroup label="Sans signal-prix (sans tarification volum√©trique)" data-i18n="leaks.group_without_price">
                            <option value="menage_sans_tarif" data-i18n="leaks.household_no_tariff">M√©nage (sans tarif)</option>
                            <option value="quebec_sans_tarif" data-i18n="leaks.quebec_no_tariff">Qu√©bec (sans tarif)</option>
                            <option value="deux_stocks_sans_tarif" selected data-i18n="leaks.two_stocks_no_tariff">QC diff√©renci√© (sans tarif)</option>
                        </optgroup>

                        <optgroup label="Avanc√©" data-i18n="leaks.group_advanced">
                            <option value="custom" data-i18n="leaks.custom">Personnalis√©</option>
                        </optgroup>
                    </select>

                    <div class="input-group" style="margin-top:0.75rem;">
                        <label style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
                            <span data-i18n="param.pricing">Signal-prix actif</span>
                            <input type="checkbox" id="tarification" onchange="onTarificationToggle()">
                        </label>
                        <div class="signal-prix-box" id="signal-prix-box">
                            <div class="signal-prix-indicator">
                                <i data-lucide="info" class="lucide-sm"></i>
                                <span id="signal-prix-status">Sans signal-prix</span>
                                <span class="signal-prix-rate" id="signal-prix-rate">‚Üí Taux r√©paration: <b>55%</b></span>
                            </div>
                            <small class="help-text">
                                <b>Signal-prix</b> = tarification au m¬≥ (le m√©nage paie selon sa consommation).<br>
                                <span style="color:#059669;">‚óè Avec:</span> facture ‚Üë si fuite ‚Üí forte motivation √† r√©parer (<b>85%</b>)<br>
                                <span style="color:#dc2626;">‚óè Sans (Qu√©bec):</span> eau incluse dans taxes ‚Üí motivation r√©duite (<b>55%</b>)
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Param√®tres avanc√©s fuites (collapsible) -->
                <div class="advanced-params" id="advanced-fuites" style="display: none;">
                    <div class="advanced-header" onclick="toggleAdvanced()">
                        <span>Param√®tres avanc√©s des fuites</span>
                        <span class="chevron" id="chevron-fuites"><i data-lucide="chevron-down"></i></span>
                    </div>
                    <div class="advanced-content" id="content-fuites">
                        <div class="param-section">
                            <div class="section-title">Petites fuites (toilettes, robinets)</div>
                            <div class="input-group">
                                <label>Pr√©valence petites <span class="value" id="val-prevalence-petites">24 %</span></label>
                                <input type="range" id="prevalence-petites" min="0" max="40" step="1" value="24" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">% de m√©nages avec petite fuite</small>
                            </div>
                            <div class="input-group">
                                <label>D√©bit petites fuites <span class="value" id="val-debit-petites">10 m¬≥/an</span></label>
                                <input type="range" id="debit-petites" min="1" max="30" step="1" value="10" oninput="onParamChange()">
                            </div>
                        </div>
                        <div class="param-section">
                            <div class="section-title">Grosses fuites (conduites, chauffe-eau)</div>
                            <div class="input-group">
                                <label>Pr√©valence grosses <span class="value" id="val-prevalence-grosses">6 %</span></label>
                                <input type="range" id="prevalence-grosses" min="0" max="20" step="0.5" value="6" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">% de m√©nages avec grosse fuite</small>
                            </div>
                            <div class="input-group">
                                <label>D√©bit grosses fuites <span class="value" id="val-debit-grosses">50 m¬≥/an</span></label>
                                <input type="range" id="debit-grosses" min="20" max="150" step="5" value="50" oninput="onParamChange()">
                            </div>
                        </div>
                        <div class="info-badge" style="margin: 0.75rem 0; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 1px solid #6ee7b7;">
                            <i data-lucide="pie-chart" class="lucide-md"></i>
                            <span><strong>Total :</strong> <span id="val-prevalence-total-calc">30</span>% des m√©nages ont une fuite (petites + grosses)</span>
                        </div>
                        <div class="param-section">
                            <div class="section-title">D√©tection & R√©paration</div>
                            <div class="input-group">
                                <label>Taux de d√©tection AMI <span class="value" id="val-taux-detection">90 %</span></label>
                                <input type="range" id="taux-detection" min="50" max="100" step="1" value="90" oninput="onParamChange()">
                            </div>
                            <div class="input-group">
                                <label>Taux de r√©paration (base) <span class="value" id="val-taux-reparation">55 %</span></label>
                                <input type="range" id="taux-reparation" min="20" max="100" step="1" value="55" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">Sans tarification volum√©trique</small>
                            </div>
                            <div class="input-group">
                                <label>Facteur d√©tection grosses <span class="value" id="val-facteur-detection-sig">√ó1.2</span></label>
                                <input type="range" id="facteur-detection-sig" min="0.5" max="2" step="0.1" value="1.2" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">Grosses fuites plus visibles</small>
                            </div>
                            <div class="input-group">
                                <label>Facteur r√©paration grosses <span class="value" id="val-facteur-reparation-sig">√ó1.4</span></label>
                                <input type="range" id="facteur-reparation-sig" min="0.5" max="2" step="0.1" value="1.4" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">Grosses fuites = plus d'incitatif (dommages)</small>
                            </div>
                        </div>
                        <div class="param-section">
                            <div class="section-title">Dynamique temporelle</div>
                            <div class="input-group">
                                <label>Nouvelles fuites/an <span class="value" id="val-nouvelles-fuites">5 %</span></label>
                                <input type="range" id="nouvelles-fuites" min="0" max="15" step="0.5" value="5" oninput="onParamChange()">
                            </div>
                            <div class="input-group">
                                <label>Fuites persistantes <span class="value" id="val-persistantes">10 %</span></label>
                                <input type="range" id="persistantes" min="0" max="30" step="1" value="10" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">% jamais r√©par√©es</small>
                            </div>
                            <div class="input-group">
                                <label>Facteur longue tra√Æne <span class="value" id="val-longue-traine">√ó5.0</span></label>
                                <input type="range" id="longue-traine" min="1" max="10" step="0.5" value="5" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">Ralentissement r√©parations dans le temps</small>
                            </div>
                        </div>
                        <div class="param-section">
                            <div class="section-title">Co√ªts de r√©paration</div>
                            <div class="input-group">
                                <label>Co√ªt petite fuite <span class="value" id="val-cout-petite">150 $</span></label>
                                <input type="range" id="cout-petite" min="50" max="500" step="10" value="150" oninput="onParamChange()">
                            </div>
                            <div class="input-group">
                                <label>Co√ªt grosse fuite <span class="value" id="val-cout-grosse">600 $</span></label>
                                <input type="range" id="cout-grosse" min="200" max="2000" step="50" value="600" oninput="onParamChange()">
                            </div>
                            <div class="input-group">
                                <label>Part ville (subvention) <span class="value" id="val-part-ville">0 %</span></label>
                                <input type="range" id="part-ville" min="0" max="100" step="5" value="0" oninput="onParamChange()">
                                <small style="color: #666; font-size: 10px;">0% = m√©nage paie tout, 100% = ville paie tout</small>
                            </div>
                            <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="inclure-couts" checked onchange="onParamChange()">
                                <label for="inclure-couts" style="margin: 0;">Inclure co√ªts de r√©paration dans la VAN</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deployment / Adoption -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon blue">üöÄ</div>
                    <div>
                        <div class="card-title" data-i18n="section.deployment">D√©ploiement (adoption)</div>
                        <div class="card-subtitle" data-i18n="section.deployment_sub">Simule un d√©ploiement progressif</div>
                    </div>
                </div>

                <div class="input-group">
                    <label data-i18n="param.adoption_scenario">Sc√©nario d'adoption</label>
                    <select id="scenario-adoption" onchange="onScenarioAdoptionChange()">
                        <option value="obligatoire" selected data-i18n="adoption.mandatory">Obligatoire (100% d√®s l'ann√©e 1)</option>
                        <option value="rapide" data-i18n="adoption.fast">Rapide</option>
                        <option value="progressive" data-i18n="adoption.progressive">Progressif</option>
                        <option value="lent" data-i18n="adoption.slow">Lent</option>
                        <option value="nouveaux" data-i18n="adoption.new_households">Nouveaux m√©nages</option>
                        <option value="par_secteur" data-i18n="adoption.by_sector">Par secteur</option>
                        <option value="custom" data-i18n="adoption.custom">Personnalis√©</option>
                        <option value="none" data-i18n="adoption.disabled">D√©sactiv√© (test)</option>
                    </select>
                </div>

                <div id="advanced-adoption" style="display:none;">
                    <div class="input-group">
                        <label><span data-i18n="adoption.max">Adoption max (%)</span> <span class="value" id="val-adoption-max">95</span></label>
                        <input type="range" id="adoption-max" min="0" max="100" step="1" value="95" oninput="onParamChange()">
                    </div>

                    <div class="input-group">
                        <label><span data-i18n="adoption.speed">Vitesse (k)</span> <span class="value" id="val-adoption-k">0.50</span></label>
                        <input type="range" id="adoption-k" min="0.1" max="2.0" step="0.05" value="0.5" oninput="onParamChange()">
                    </div>

                    <div class="input-group">
                        <label><span data-i18n="adoption.midpoint">Point m√©dian (t0)</span> <span class="value" id="val-adoption-t0">5</span></label>
                        <input type="range" id="adoption-t0" min="1" max="20" step="1" value="5" oninput="onParamChange()">
                    </div>

                    <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="adoption-etaler-capex" checked onchange="onParamChange()">
                        <label for="adoption-etaler-capex" style="margin: 0;" data-i18n="adoption.spread_capex">√âtaler le CAPEX</label>
                    </div>
                </div>
            </div>

            <!-- Fuites r√©seau -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon orange">üåê</div>
                    <div>
                        <div class="card-title" data-i18n="section.network">Fuites r√©seau</div>
                        <div class="card-subtitle" data-i18n="section.network_sub">R√©duction des pertes r√©seau (optionnel)</div>
                    </div>
                </div>

                <div class="input-group">
                    <label><input type="checkbox" id="reseau-activer" onchange="onReseauToggle()"> <span data-i18n="network.enable">Activer</span></label>
                </div>

                <div id="advanced-reseau" style="display:none;">
                    <div class="input-group">
                        <label data-i18n="network.losses">Pertes r√©seau (m¬≥/an)</label>
                        <input type="number" id="reseau-volume" value="0" min="0" step="1000" oninput="onParamChange()">
                    </div>

                    <div class="input-group">
                        <label><span data-i18n="network.max_reduction">R√©duction max (%)</span> <span class="value" id="val-reseau-reduc-max">0</span></label>
                        <input type="range" id="reseau-reduc-max" min="0" max="100" step="1" value="0" oninput="onParamChange()">
                    </div>

                    <div class="input-group">
                        <label data-i18n="network.mode">Mode</label>
                        <select id="reseau-mode" onchange="onParamChange()">
                            <option value="lineaire" selected data-i18n="network.linear">Lin√©aire</option>
                            <option value="exponentiel" data-i18n="network.exponential">Exponentiel</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label data-i18n="network.years">Ann√©es pour atteindre</label>
                        <input type="number" id="reseau-annees" value="5" min="1" max="40" step="1" oninput="onParamChange()">
                    </div>

                    <div class="input-group">
                        <label><input type="checkbox" id="reseau-pondere" checked onchange="onParamChange()"> <span data-i18n="network.weight_adoption">Pond√©rer par adoption</span></label>
                    </div>
                </div>
            </div>

            <!-- Economic Parameters -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon blue"><i data-lucide="wallet"></i></div>
                    <div>
                        <div class="card-title" data-i18n="section.economic">Param√®tres √©conomiques</div>
                        <div class="card-subtitle" data-i18n="section.economic_sub">Valorisation de l'eau</div>
                    </div>
                </div>

                <div class="toggle-container">
                    <div class="toggle" id="mode-toggle" onclick="toggleMode()"></div>
                    <span class="toggle-label" id="mode-label" data-i18n="economic.mode_economic">Mode √âconomique (valeur sociale)</span>
                </div>

                <div class="input-group">
                    <label data-i18n="economic.water_preset">Valeur de l'eau (preset)</label>
                    <select id="valeur-eau-preset" onchange="onValeurEauPresetChange()">
                        <option value="custom" selected data-i18n="economic.custom">Personnalis√©</option>
                        <option value="quebec" data-i18n="economic.quebec">Qu√©bec</option>
                        <option value="conservateur" data-i18n="economic.conservative">Conservateur</option>
                        <option value="rarete" data-i18n="economic.scarcity">Raret√©</option>
                        <option value="quebec_mcf" data-i18n="economic.quebec_mcf">Qu√©bec + MCF</option>
                    </select>
                </div>

                <div class="input-group">
                    <label><span data-i18n="economic.social_value">Valeur sociale de l'eau</span> <span class="value" id="val-valeur-sociale">4.69 $/m¬≥</span></label>
                    <input type="range" id="valeur-sociale" min="1" max="12" step="0.1" value="4.69" oninput="onParamChange()">
                </div>

                <div class="input-group">
                    <label><span data-i18n="economic.variable_cost">Co√ªt variable de production</span> <span class="value" id="val-cout-variable">0.50 $/m¬≥</span></label>
                    <input type="range" id="cout-variable" min="0.1" max="2" step="0.05" value="0.5" oninput="onParamChange()">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="economies-echelle" onchange="onParamChange()" style="width: 18px; height: 18px;">
                        <span data-i18n="economic.economies_scale">√âconomies d'√©chelle (>10k compteurs)</span>
                    </label>
                    <small style="color: #666; font-size: 11px; margin-top: 4px; display: block;" data-i18n="economic.economies_scale_help">
                        R√©duction 5-20% sur co√ªts mat√©riel selon volume
                    </small>
                </div>

                <!-- Report d'infrastructure -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span>üèóÔ∏è</span> <span data-i18n="economic.infra_deferral">Report d'infrastructure (optionnel)</span>
                    </div>
                    <small style="color: #666; font-size: 11px; display: block; margin-bottom: 12px;" data-i18n="economic.infra_deferral_help">
                        Valorise les √©conomies en eau par le report d'investissements en infrastructure (stations, r√©seaux).
                    </small>

                    <div class="input-group">
                        <label><span data-i18n="economic.annual_benefit">B√©n√©fice annuel fixe</span> <span class="value" id="val-report-infra-annuel">0 $/an</span></label>
                        <input type="range" id="report-infra-annuel" min="0" max="500000" step="10000" value="0" oninput="onParamChange()">
                        <small style="color: #666; font-size: 10px;" data-i18n="economic.annual_benefit_help">Report capacit√©: usine, r√©servoirs ($/an)</small>
                    </div>

                    <div class="input-group">
                        <label><span data-i18n="economic.benefit_per_m3">B√©n√©fice par m¬≥ √©conomis√©</span> <span class="value" id="val-report-infra-m3">0.00 $/m¬≥</span></label>
                        <input type="range" id="report-infra-m3" min="0" max="5" step="0.1" value="0" oninput="onParamChange()">
                        <small style="color: #666; font-size: 10px;" data-i18n="economic.benefit_per_m3_help">Co√ªt marginal infrastructure √©vit√©</small>
                    </div>
                </div>
            </div>

            <!-- Monte Carlo Settings -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon purple">üé≤</div>
                    <div>
                        <div class="card-title" data-i18n="section.monte_carlo">Monte Carlo</div>
                        <div class="card-subtitle" data-i18n="section.monte_carlo_sub">Param√®tres de simulation</div>
                    </div>
                </div>

                <div class="input-group">
                    <label data-i18n="mc.simulations">Monte Carlo ‚Äì Simulations</label>
                    <input type="number" id="montecarlo-sims" value="500" min="100" step="50">
                </div>

                <div class="input-group">
                    <label data-i18n="mc.seed">Monte Carlo ‚Äì Seed</label>
                    <input type="number" id="montecarlo-seed" value="42" min="0" step="1">
                </div>

                <!-- Configuration distributions avanc√©e -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="toggleMCDistributions()">
                        <i data-lucide="bar-chart-2" class="lucide-md"></i> <span data-i18n="mc.custom_distributions">Distributions personnalis√©es</span>
                        <span id="mc-distrib-toggle" class="toggle-chevron" style="margin-left: auto;"><i data-lucide="chevron-right"></i></span>
                    </div>

                    <div id="mc-distributions-section" style="display: none;">
                        <small style="color: #666; font-size: 11px; display: block; margin-bottom: 12px;" data-i18n="mc.custom_distributions_help">
                            Configurez les distributions pour chaque param√®tre cl√©.
                        </small>

                        <!-- Alpha0 (r√©duction comportementale) -->
                        <div class="mc-param-config" style="margin-bottom: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                            <label style="font-size: 12px; font-weight: 600; color: #374151;" data-i18n="mc.behavior_reduction">R√©duction comportementale (%)</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 6px;">
                                <div>
                                    <small style="color: #666;" data-i18n="mc.min">Min</small>
                                    <input type="number" id="mc-alpha0-min" value="4" step="0.5" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.mode">Mode</small>
                                    <input type="number" id="mc-alpha0-mode" value="8" step="0.5" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.max">Max</small>
                                    <input type="number" id="mc-alpha0-max" value="12" step="0.5" style="width: 100%; padding: 4px;">
                                </div>
                            </div>
                        </div>

                        <!-- LPCD -->
                        <div class="mc-param-config" style="margin-bottom: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                            <label style="font-size: 12px; font-weight: 600; color: #374151;" data-i18n="mc.lpcd">LPCD (L/pers/jour)</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 6px;">
                                <div>
                                    <small style="color: #666;" data-i18n="mc.min">Min</small>
                                    <input type="number" id="mc-lpcd-min" value="200" step="10" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.mode">Mode</small>
                                    <input type="number" id="mc-lpcd-mode" value="236" step="10" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.max">Max</small>
                                    <input type="number" id="mc-lpcd-max" value="280" step="10" style="width: 100%; padding: 4px;">
                                </div>
                            </div>
                        </div>

                        <!-- Co√ªt compteur -->
                        <div class="mc-param-config" style="margin-bottom: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                            <label style="font-size: 12px; font-weight: 600; color: #374151;" data-i18n="mc.meter_cost">Co√ªt compteur ($)</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 6px;">
                                <div>
                                    <small style="color: #666;" data-i18n="mc.min">Min</small>
                                    <input type="number" id="mc-cout-min" value="180" step="10" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.mode">Mode</small>
                                    <input type="number" id="mc-cout-mode" value="250" step="10" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.max">Max</small>
                                    <input type="number" id="mc-cout-max" value="350" step="10" style="width: 100%; padding: 4px;">
                                </div>
                            </div>
                        </div>

                        <!-- Valeur eau -->
                        <div class="mc-param-config" style="margin-bottom: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                            <label style="font-size: 12px; font-weight: 600; color: #374151;" data-i18n="mc.water_value">Valeur eau ($/m¬≥)</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 6px;">
                                <div>
                                    <small style="color: #666;" data-i18n="mc.min">Min</small>
                                    <input type="number" id="mc-valeur-min" value="3.5" step="0.1" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.mode">Mode</small>
                                    <input type="number" id="mc-valeur-mode" value="4.69" step="0.1" style="width: 100%; padding: 4px;">
                                </div>
                                <div>
                                    <small style="color: #666;" data-i18n="mc.max">Max</small>
                                    <input type="number" id="mc-valeur-max" value="6.5" step="0.1" style="width: 100%; padding: 4px;">
                                </div>
                            </div>
                        </div>

                        <div class="input-group" style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="mc-use-custom" style="width: 18px; height: 18px;">
                                <span data-i18n="mc.use_custom">Utiliser distributions personnalis√©es</span>
                            </label>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button class="btn" style="flex: 1; font-size: 11px; padding: 6px;" onclick="exportMCConfig()" data-i18n="mc.export_config">Exporter config</button>
                            <button class="btn" style="flex: 1; font-size: 11px; padding: 6px;" onclick="importMCConfig()" data-i18n="mc.import_config">Importer config</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optimisation d√©ploiement -->
            <div class="card">
                <div class="card-header" style="cursor: pointer;" onclick="toggleOptimization()">
                    <div class="card-icon blue"><i data-lucide="target"></i></div>
                    <div>
                        <div class="card-title" data-i18n="section.optimization">Optimisation</div>
                        <div class="card-subtitle" data-i18n="section.optimization_sub">D√©ploiement sous contraintes</div>
                    </div>
                    <span id="optim-toggle-icon" class="toggle-chevron" style="margin-left: auto;"><i data-lucide="chevron-right"></i></span>
                </div>

                <div id="optimization-section" style="display: none;">
                    <div class="input-group">
                        <label><span data-i18n="optim.budget_max">Budget annuel max</span> <span class="value" id="val-budget-max">5 M$</span></label>
                        <input type="range" id="budget-max" min="500000" max="20000000" step="500000" value="5000000" oninput="updateOptimLabels()">
                    </div>

                    <div class="input-group">
                        <label><span data-i18n="optim.capacity_max">Capacit√© installation</span> <span class="value" id="val-capacite-max">20 000 /an</span></label>
                        <input type="range" id="capacite-max" min="5000" max="100000" step="5000" value="20000" oninput="updateOptimLabels()">
                    </div>

                    <div class="input-group">
                        <label data-i18n="optim.objective">Objectif</label>
                        <select id="optim-objectif">
                            <option value="van" data-i18n="optim.maximize_van">Maximiser la VAN</option>
                            <option value="payback" data-i18n="optim.minimize_payback">Minimiser le payback</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label><span data-i18n="optim.horizon">Horizon d√©ploiement</span> <span class="value" id="val-horizon-deploy">10 ans</span></label>
                        <input type="range" id="horizon-deploy" min="3" max="15" step="1" value="10" oninput="updateOptimLabels()">
                    </div>

                    <button class="btn" style="width: 100%; margin-top: 10px;" onclick="runOptimization()">
                        <i data-lucide="target" class="lucide-sm"></i> <span data-i18n="optim.run">Optimiser le d√©ploiement</span>
                    </button>

                    <div id="optim-results" style="display: none; margin-top: 15px; padding: 12px; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-weight: 600; color: #166534; margin-bottom: 8px;" data-i18n="optim.optimal">Sc√©nario optimal</div>
                        <div style="font-size: 12px; color: #15803d;" id="optim-result-text"></div>
                    </div>
                </div>
            </div>

            <!-- Mode Expert -->
            <div class="card">
                <div class="card-header" style="cursor: pointer;" onclick="toggleExpertMode()">
                    <div class="card-icon orange"><i data-lucide="settings"></i></div>
                    <div>
                        <div class="card-title" data-i18n="section.expert">Mode Expert</div>
                        <div class="card-subtitle" data-i18n="section.expert_sub">Param√®tres avanc√©s</div>
                    </div>
                    <span id="expert-toggle-icon" class="toggle-chevron" style="margin-left: auto;"><i data-lucide="chevron-right"></i></span>
                </div>

                <div id="expert-section" style="display: none;">
                    <!-- Presets Expert -->
                    <div class="input-group">
                        <label data-i18n="expert.preset">Preset expert</label>
                        <select id="expert-preset" onchange="onExpertPresetChange()">
                            <option value="standard" selected data-i18n="expert.standard">Standard (d√©faut)</option>
                            <option value="conservateur" data-i18n="expert.conservative">Conservateur (prudent)</option>
                            <option value="agressif" data-i18n="expert.aggressive">Agressif (optimiste)</option>
                            <option value="custom" data-i18n="expert.custom">Personnalis√©</option>
                        </select>
                    </div>

                    <!-- MCF Section -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="coins" class="lucide-md"></i> <span data-i18n="expert.mcf">Co√ªt Marginal des Fonds publics (MCF)</span>
                        </div>
                        <small style="color: #666; font-size: 11px; display: block; margin-bottom: 12px;" data-i18n="expert.mcf_help">
                            Le MCF repr√©sente le co√ªt social de lever 1$ de taxes. Treasury Board Canada: 0.20
                        </small>

                        <div class="input-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="appliquer-mcf" onchange="onParamChange()" style="width: 18px; height: 18px;">
                                <span data-i18n="expert.apply_mcf">Appliquer le MCF aux d√©penses publiques</span>
                            </label>
                        </div>

                        <div class="input-group">
                            <label><span data-i18n="expert.mcf_value">Valeur MCF</span> <span class="value" id="val-mcf">0.20</span></label>
                            <input type="range" id="mcf" min="0.05" max="0.50" step="0.01" value="0.20" oninput="onParamChange()">
                        </div>
                    </div>

                    <!-- Persistance avanc√©e -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <span>üìâ</span> <span data-i18n="expert.persistence_advanced">Persistance comportementale (avanc√©)</span>
                        </div>
                        <small style="color: #666; font-size: 11px; display: block; margin-bottom: 12px;" data-i18n="expert.persistence_help">
                            Param√®tres fins pour le mod√®le de d√©croissance comportementale.
                        </small>

                        <div class="input-group">
                            <label><span data-i18n="expert.lambda_decay">Lambda d√©croissance</span> <span class="value" id="val-lambda-decay">0.15</span></label>
                            <input type="range" id="lambda-decay" min="0.05" max="0.40" step="0.01" value="0.15" oninput="onParamChange()">
                            <small style="color: #666; font-size: 10px;" data-i18n="expert.lambda_decay_help">Vitesse de d√©clin vers le plateau (mode r√©aliste)</small>
                        </div>

                        <div class="input-group">
                            <label><span data-i18n="expert.alpha_plateau">Alpha plateau (%)</span> <span class="value" id="val-alpha-plateau">2.5</span></label>
                            <input type="range" id="alpha-plateau" min="0" max="10" step="0.5" value="2.5" oninput="onParamChange()">
                            <small style="color: #666; font-size: 10px;" data-i18n="expert.alpha_plateau_help">R√©duction r√©siduelle √† long terme</small>
                        </div>
                    </div>

                    <!-- Externalit√©s -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <span>üåç</span> <span data-i18n="expert.externalities">Externalit√©s environnementales</span>
                        </div>

                        <div class="input-group">
                            <label><span data-i18n="expert.externalities_value">Valeur externalit√©s</span> <span class="value" id="val-externalites">0.50 $/m¬≥</span></label>
                            <input type="range" id="externalites" min="0" max="3" step="0.1" value="0.5" oninput="onParamChange()">
                            <small style="color: #666; font-size: 10px;" data-i18n="expert.externalities_help">Carbone, √©cosyst√®mes (inclus dans valeur sociale)</small>
                        </div>
                    </div>

                    <!-- OPEX d√©taill√© -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="bar-chart-2" class="lucide-md"></i> <span data-i18n="expert.opex_detailed">OPEX d√©taill√© (AMI)</span>
                        </div>
                        <small style="color: #666; font-size: 11px; display: block; margin-bottom: 12px;" data-i18n="expert.opex_detailed_help">
                            Ventilation des co√ªts op√©rationnels non-techniques AMI.
                        </small>

                        <div class="input-group">
                            <label><span data-i18n="expert.cyber">Cybers√©curit√©</span> <span class="value" id="val-opex-cyber">3.00 $/u/an</span></label>
                            <input type="range" id="opex-cyber" min="0" max="10" step="0.5" value="3" oninput="onParamChange()">
                        </div>

                        <div class="input-group">
                            <label><span data-i18n="expert.licenses">Licences logicielles</span> <span class="value" id="val-opex-licences">5.00 $/u/an</span></label>
                            <input type="range" id="opex-licences" min="0" max="15" step="0.5" value="5" oninput="onParamChange()">
                        </div>

                        <div class="input-group">
                            <label><span data-i18n="expert.storage">Stockage donn√©es</span> <span class="value" id="val-opex-stockage">2.00 $/u/an</span></label>
                            <input type="range" id="opex-stockage" min="0" max="8" step="0.5" value="2" oninput="onParamChange()">
                        </div>

                        <div class="input-group">
                            <label><span data-i18n="expert.telecom">T√©l√©com</span> <span class="value" id="val-opex-telecom">5.00 $/u/an</span></label>
                            <input type="range" id="opex-telecom" min="0" max="15" step="0.5" value="5" oninput="onParamChange()">
                        </div>

                        <div style="margin-top: 10px; padding: 8px 12px; background: #f3f4f6; border-radius: 6px;">
                            <small style="color: #374151;">
                                <strong data-i18n="expert.opex_total">Total OPEX non-tech:</strong> <span id="val-opex-total">15.00 $/u/an</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main class="main" id="main-content" role="main">
            <!-- Metrics -->
            <div class="metrics-grid" role="region" aria-label="Indicateurs cl√©s">
                <div class="metric-card primary">
                    <div class="metric-label">Valeur Actualis√©e Nette</div>
                    <div class="metric-value" id="metric-van">‚Äî</div>
                    <div class="metric-change">sur 20 ans</div>
                </div>
                <div class="metric-card" id="rbc-card">
                    <div class="metric-label">Ratio B√©n√©fices/Co√ªts</div>
                    <div class="metric-value" id="metric-rbc">‚Äî</div>
                    <div class="metric-change">seuil: 1.00</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">P√©riode de r√©cup√©ration</div>
                    <div class="metric-value" id="metric-payback">‚Äî</div>
                    <div class="metric-change">ann√©es</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">LCSW</div>
                    <div class="metric-value" id="metric-lcsw">‚Äî</div>
                    <div class="metric-change">$/m¬≥ √©conomis√©</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Investissement total</div>
                    <div class="metric-value" id="metric-invest">‚Äî</div>
                    <div class="metric-change">initial</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">√âconomies d'eau</div>
                    <div class="metric-value" id="metric-economies">‚Äî</div>
                    <div class="metric-change">m¬≥/m√©nage/an</div>
                </div>
            </div>

            <!-- Actions bar hidden (too cluttered) -->
            <div class="actions-bar" style="display: none;">
                <button class="btn" onclick="exportJSON()" data-i18n="action.export_json">Exporter JSON</button>
                <button class="btn" onclick="exportCSV()" data-i18n="action.export_csv">Exporter CSV</button>
                <button class="btn" onclick="exportPDF()" data-i18n="action.export_pdf">Exporter PDF</button>
                <button class="btn" onclick="copyPermalink()" data-i18n="action.copy_link">Copier lien</button>
                <button class="btn" onclick="saveScenario()" style="background: #059669;" data-i18n="action.save">Sauvegarder</button>
                <button class="btn" onclick="toggleComparator()" style="background: #7c3aed;" data-i18n="action.comparator">Comparateur</button>
            </div>

            <!-- Comparateur de sc√©narios (hidden) -->
            <div id="comparator-panel" style="display: none; margin-top: 1rem;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #374151;">
                            <i data-lucide="git-compare" class="lucide-md"></i> <span data-i18n="comparator.title">Sc√©narios sauvegard√©s</span>
                        </div>
                        <button class="btn" onclick="clearSavedScenarios()" style="background: #dc2626; font-size: 11px; padding: 5px 10px;" data-i18n="comparator.clear_all">Tout effacer</button>
                    </div>
                    <div id="saved-scenarios-list" style="font-size: 12px;"></div>
                    <div id="comparison-table" style="margin-top: 15px; display: none;">
                        <table class="breakdown-table" style="font-size: 11px;">
                            <thead>
                                <tr>
                                    <th data-i18n="comparator.scenario">Sc√©nario</th>
                                    <th>VAN</th>
                                    <th>RBC</th>
                                    <th>Payback</th>
                                    <th data-i18n="comparator.actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Scenario Badge -->
            <div class="scenario-badge" id="scenario-badge">
                <div class="scenario-icon"><i data-lucide="layers" class="lucide-lg"></i></div>
                <div class="scenario-info">
                    <div class="scenario-label">Sc√©nario actuel</div>
                    <div class="scenario-name" id="scenario-name">R√©aliste + R√©aliste</div>
                </div>
                <div class="scenario-details" id="scenario-details">
                    <span class="tag tag-persistance">R√©aliste</span>
                    <span class="tag tag-fuites">R√©aliste</span>
                    <span class="tag tag-mode">√âconomique</span>
                </div>
            </div>

            <div id="calibration-warnings" style="display:none;margin-top:1rem;"></div>

            <!-- Hypoth√®ses effectives (collapsible) -->
            <div class="card" style="margin-top: 1rem; cursor: pointer;" onclick="toggleHypotheses()">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2em;">üìã</span>
                        <span style="font-weight: 600; color: #374151;" data-i18n="hypotheses.title">Hypoth√®ses effectives</span>
                        <span style="font-size: 11px; color: #6b7280;" data-i18n="hypotheses.expand">(cliquer pour d√©velopper)</span>
                    </div>
                    <span id="chevron-hypotheses" class="toggle-chevron open"><i data-lucide="chevron-down"></i></span>
                </div>
                <div id="hypotheses-content" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 12px;">
                        <div>
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;"><i data-lucide="home" class="lucide-sm"></i> <span data-i18n="hypotheses.project">Projet</span></div>
                            <div id="hyp-projet"></div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">üíµ <span data-i18n="hypotheses.costs">Co√ªts</span></div>
                            <div id="hyp-couts"></div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">üöÄ <span data-i18n="hypotheses.deployment">D√©ploiement</span></div>
                            <div id="hyp-deploiement"></div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;"><i data-lucide="droplet" class="lucide-sm"></i> <span data-i18n="hypotheses.leaks">Fuites</span></div>
                            <div id="hyp-fuites"></div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;"><i data-lucide="trending-up" class="lucide-sm"></i> <span data-i18n="hypotheses.behavior">Comportement</span></div>
                            <div id="hyp-comportement"></div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;"><i data-lucide="badge-dollar-sign" class="lucide-sm"></i> <span data-i18n="hypotheses.valuation">Valorisation</span></div>
                            <div id="hyp-valorisation"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- M√©thodologie (collapsible) -->
            <div class="card" style="margin-top: 1rem; cursor: pointer;" onclick="toggleMethodo()">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2em;">üìê</span>
                        <span style="font-weight: 600; color: #374151;" data-i18n="methodology.title">M√©thodologie</span>
                        <span style="font-size: 11px; color: #6b7280;" data-i18n="methodology.expand">(formules et conventions)</span>
                    </div>
                    <span id="chevron-methodo" class="toggle-chevron open"><i data-lucide="chevron-down"></i></span>
                </div>
                <div id="methodo-content" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #4b5563; line-height: 1.7;">
                    <div style="margin-bottom: 12px;">
                        <strong data-i18n="methodology.van_formula">Valeur Actualis√©e Nette (VAN)</strong><br>
                        <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 11px;">
                            VAN = Œ£ (B√©n√©fices_t - Co√ªts_t) / (1+r)^t - Investissement_0
                        </code>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <strong data-i18n="methodology.sign_conventions">Conventions de signes</strong><br>
                        ‚Ä¢ <span style="color: #10b981;" data-i18n="methodology.benefits">B√©n√©fices (+)</span>: <span data-i18n="methodology.benefits_desc">√©conomies d'eau valoris√©es, report d'infrastructure</span><br>
                        ‚Ä¢ <span style="color: #ef4444;" data-i18n="methodology.costs">Co√ªts (‚àí)</span>: <span data-i18n="methodology.costs_desc">investissement initial (CAPEX), exploitation (OPEX)</span>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <strong data-i18n="methodology.perspectives">Perspectives d'analyse</strong><br>
                        ‚Ä¢ <b>√âconomique</b>: <span data-i18n="methodology.economic_desc">valorise l'eau au co√ªt social complet (inclut externalit√©s)</span><br>
                        ‚Ä¢ <b>Financier</b>: <span data-i18n="methodology.financial_desc">valorise l'eau au co√ªt variable √©vit√© uniquement</span>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <strong data-i18n="methodology.indicators">Indicateurs cl√©s</strong><br>
                        ‚Ä¢ <b>RBC</b>: <span data-i18n="methodology.rbc_desc">viable si > 1</span><br>
                        ‚Ä¢ <b>LCSW</b>: <span data-i18n="methodology.lcsw_desc">co√ªt pour √©conomiser 1 m¬≥ d'eau</span><br>
                        ‚Ä¢ <b>Payback</b>: <span data-i18n="methodology.payback_desc">ann√©es pour r√©cup√©rer l'investissement</span>
                    </div>
                    <div style="font-size: 11px; color: #9ca3af;" data-i18n="methodology.sources">
                        Sources: MAMH (2019-2025), m√©thodologie CBA standard du Conseil du Tr√©sor.
                    </div>
                </div>
            </div>

            <!-- Recommendation -->
            <div class="recommendation positive" id="recommendation">
                <div class="recommendation-icon"><i data-lucide="loader" class="animate-spin"></i></div>
                <div class="recommendation-text">Chargement de l'analyse...</div>
            </div>

            <!-- Monte Carlo Stats -->
            <div class="mc-stats-grid" id="mc-stats" style="display: none;">
                <div class="mc-stat-card">
                    <div class="mc-stat-label" data-i18n="mc.prob_positive">P(VAN > 0)</div>
                    <div class="mc-stat-value" id="mc-prob">‚Äî</div>
                </div>
                <div class="mc-stat-card">
                    <div class="mc-stat-label" data-i18n="mc.median">VAN M√©diane</div>
                    <div class="mc-stat-value" id="mc-median">‚Äî</div>
                </div>
                <div class="mc-stat-card">
                    <div class="mc-stat-label" data-i18n="mc.ci_90">IC 90% (P5-P95)</div>
                    <div class="mc-stat-value" id="mc-ic">‚Äî</div>
                </div>
                <div class="mc-stat-card">
                    <div class="mc-stat-label" data-i18n="mc.std">√âcart-type</div>
                    <div class="mc-stat-value" id="mc-std">‚Äî</div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.van_cumulative">VAN Cumulative</div>
                            <div class="chart-subtitle" data-i18n="chart.van_cumulative_sub">√âvolution sur l'horizon d'analyse</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-van"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.sensitivity">Sensibilit√© des Param√®tres (Tornado)</div>
                            <div class="chart-subtitle" data-i18n="chart.sensitivity_sub">Impact d'une variation de ¬±10%</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-sensitivity"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.waterfall">Contribution √† la VAN (Waterfall)</div>
                            <div class="chart-subtitle" data-i18n="chart.waterfall_sub">D√©composition des b√©n√©fices et co√ªts</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-waterfall"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.technologies">Comparaison des Technologies</div>
                            <div class="chart-subtitle" data-i18n="chart.technologies_sub">VAN selon le type de compteur</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-types"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.persistence">Sc√©narios de Persistance</div>
                            <div class="chart-subtitle" data-i18n="chart.persistence_sub">Impact du maintien des comportements</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-persistance"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.alpha">Courbe Œ± ‚Äî Effet Comportemental</div>
                            <div class="chart-subtitle" data-i18n="chart.alpha_sub">√âvolution du coefficient de r√©duction</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-alpha"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.perspectives">Perspectives par Acteur</div>
                            <div class="chart-subtitle" data-i18n="chart.perspectives_sub">VAN: Soci√©t√© / Ville / M√©nages</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-perspectives"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.leaks">Dynamique des Fuites</div>
                            <div class="chart-subtitle" data-i18n="chart.leaks_sub">√âvolution du stock de fuites actives</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-fuites"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.decomposition">D√©composition des √âconomies</div>
                            <div class="chart-subtitle" data-i18n="chart.decomposition_sub">Comportement vs D√©tection fuites (m¬≥/m√©nage/an)</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-decomposition"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Comparaison Sc√©narios Fuites</div>
                            <div class="chart-subtitle">Impact du mod√®le de pr√©valence</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-fuites-scenarios"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.monte_carlo">Monte Carlo ‚Äî Distribution VAN</div>
                            <div class="chart-subtitle" data-i18n="chart.monte_carlo_sub">Simulation stochastique (500 tirages)</div>
                        </div>
                        <button class="btn-mc" id="btn-run-mc" onclick="runMonteCarlo()"><i data-lucide="play" class="lucide-sm"></i> <span data-i18n="action.run_mc">Lancer</span></button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-monte-carlo"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title" data-i18n="chart.drivers">Monte Carlo ‚Äî Drivers de Risque</div>
                            <div class="chart-subtitle" data-i18n="chart.drivers_sub">Corr√©lations avec la VAN</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-mc-drivers"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detail Tables -->
            <div class="detail-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon green">üìã</div>
                        <div>
                            <div class="card-title">D√©tail des flux financiers</div>
                            <div class="card-subtitle">Valeurs actualis√©es</div>
                        </div>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Composante</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody id="breakdown-body">
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon blue"><i data-lucide="droplets"></i></div>
                        <div>
                            <div class="card-title">√âconomies d'eau d√©taill√©es</div>
                            <div class="card-subtitle">Par m√©nage et par an</div>
                        </div>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Source d'√©conomie</th>
                                <th>Volume</th>
                            </tr>
                        </thead>
                        <tbody id="water-breakdown">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Leak Parameters Detail -->
            <div class="detail-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon orange">üîç</div>
                        <div>
                            <div class="card-title">Param√®tres Fuites Utilis√©s</div>
                            <div class="card-subtitle">Configuration du mod√®le</div>
                        </div>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Param√®tre</th>
                                <th>Valeur</th>
                            </tr>
                        </thead>
                        <tbody id="fuites-params-body">
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon purple">üìâ</div>
                        <div>
                            <div class="card-title">Persistance Comportementale</div>
                            <div class="card-subtitle">Mod√®le de d√©croissance</div>
                        </div>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Param√®tre</th>
                                <th>Valeur</th>
                            </tr>
                        </thead>
                        <tbody id="persistance-params-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Toggle sidebar mobile -->
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Afficher/masquer les param√®tres" onclick="toggleSidebar()">
        ‚öôÔ∏è
    </button>

    <footer class="footer" role="contentinfo">
        <div>
            <span data-i18n="footer.developed_by">Mod√®le d√©velopp√© par</span> <strong>Enzo Simier</strong> ‚Äî HEC Montr√©al<br>
            <span data-i18n="footer.project">Projet Mitacs / R√©seau Environnement Qu√©bec</span> ‚Ä¢ 2026
        </div>
        <div style="margin-top: 0.75rem;">
            <a href="https://github.com/EnzoSim/compteurs.QC" data-i18n="footer.source">Code source</a> ‚Ä¢
            <a href="#" data-i18n="footer.docs">Documentation</a> ‚Ä¢
            <a href="#" data-i18n="footer.methodology">M√©thodologie</a>
        </div>
    </footer>

    <script>
        // Configuration
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? `http://${window.location.hostname}:8000`
            : 'https://compteurs-qc.onrender.com';

        let modeEconomique = true;
        let debounceTimer = null;
        let charts = {};
        const chartColors = {
            primary: '#0f4c75',
            primaryLight: '#3282b8',
            secondary: '#00b4d8',
            success: '#06d6a0',
            warning: '#ffd166',
            danger: '#ef476f',
            info: '#17a2b8',
            grid: '#e2e8f0'
        };
        let suppressParamChange = false;
        let currentAbortController = null;  // Pour annuler les requ√™tes en cours
        let permalinkApplied = false;
        const apiCache = new Map();
        const API_CACHE_LIMIT = 50;
        const CACHEABLE_ENDPOINTS = new Set([
            '/api/calculate',
            '/api/sensitivity',
            '/api/compare_meters',
            '/api/compare_persistence',
            '/api/detailed_series',
            '/api/compare_fuites',
            '/api/validate_calibration',
        ]);

        // === LANGUE / INTERNATIONALIZATION ===
        function toggleLanguage() {
            const newLang = currentLang === 'fr' ? 'en' : 'fr';
            setLanguage(newLang);
            document.getElementById('lang-toggle').textContent = newLang.toUpperCase();
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            const overlay = document.getElementById('loading-overlay');
            const overlayText = overlay.querySelector('.loading-text');
            const overlaySubtext = overlay.querySelector('.loading-subtext');

            // Initialiser la langue
            if (typeof initLanguage === 'function') {
                initLanguage();
                document.getElementById('lang-toggle').textContent = currentLang.toUpperCase();
            }

            initCharts();
            updateLabels();

            try {
                // √âtape 1: Connexion API
                overlayText.textContent = 'Connexion au serveur...';
                overlaySubtext.textContent = 'V√©rification de l\'API';
                const apiOk = await checkApiHealth();

                if (!apiOk) {
                    overlay.classList.add('error');
                    overlayText.textContent = 'Serveur en d√©marrage...';
                    overlaySubtext.textContent = 'Render.com peut prendre 30-60s au premier acc√®s';
                    // R√©essayer apr√®s 5s
                    await new Promise(r => setTimeout(r, 5000));
                    const retry = await checkApiHealth();
                    if (!retry) {
                        overlaySubtext.textContent = 'Nouvelle tentative en cours...';
                        await new Promise(r => setTimeout(r, 10000));
                        await checkApiHealth();
                    }
                    overlay.classList.remove('error');
                }

                // √âtape 2: Chargement du mod√®le
                overlayText.textContent = 'Chargement du mod√®le...';
                overlaySubtext.textContent = 'Calcul des sc√©narios';
                const appliedPermalink = await loadFromPermalink();
                if (!appliedPermalink) {
                    await updateModel();
                }

                // Masquer l'overlay
                overlay.classList.add('hidden');
            } catch (e) {
                overlay.classList.add('error');
                overlayText.textContent = 'Erreur de connexion';
                overlaySubtext.textContent = 'Rechargez la page ou r√©essayez plus tard';
                console.error('Init error:', e);
            }
        });

        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_URL}/api/health`, { timeout: 10000 });
                if (response.ok) {
                    const statusEl = document.getElementById('api-status');
                    statusEl.setAttribute('data-i18n', 'header.api_connected');
                    statusEl.textContent = typeof t === 'function' ? t('header.api_connected') : 'API Connect√©e';
                    statusEl.className = 'api-status connected';
                    return true;
                }
                return false;
            } catch (e) {
                const statusEl = document.getElementById('api-status');
                statusEl.setAttribute('data-i18n', 'header.api_disconnected');
                statusEl.textContent = typeof t === 'function' ? t('header.api_disconnected') : 'API D√©connect√©e';
                statusEl.className = 'api-status disconnected';
                return false;
            }
        }

        function collectParams() {
            const params = {
                nb_menages: parseInt(document.getElementById('nb-menages').value),
                taille_menage: parseFloat(document.getElementById('taille-menage').value),
                lpcd: parseInt(document.getElementById('lpcd').value),
                horizon: parseInt(document.getElementById('horizon').value),
                taux_actualisation: parseFloat(document.getElementById('taux-actualisation').value),
                type_compteur: document.getElementById('type-compteur').value,
                cout_compteur: parseFloat(document.getElementById('cout-compteur').value),
                heures_installation: parseFloat(document.getElementById('heures-install').value),
                taux_horaire: parseFloat(document.getElementById('taux-horaire').value),
                cout_reseau: parseFloat(document.getElementById('cout-reseau').value),
                cout_infra_fixe: parseFloat(document.getElementById('cout-infra-fixe').value),
                cout_opex_non_tech_ami: parseFloat(document.getElementById('opex-ami').value),
                reduction_comportement: parseFloat(document.getElementById('reduction-comportement').value),
                persistance: document.getElementById('persistance').value,
                scenario_fuites: document.getElementById('scenario-fuites').value,
                scenario_adoption: document.getElementById('scenario-adoption').value,
                mode_economique: modeEconomique,
                valeur_sociale: parseFloat(document.getElementById('valeur-sociale').value),
                cout_variable: parseFloat(document.getElementById('cout-variable').value),
                valeur_eau_preset: document.getElementById('valeur-eau-preset').value,
                activer_economies_echelle: document.getElementById('economies-echelle').checked,
                benefice_report_infra_annuel: parseFloat(document.getElementById('report-infra-annuel').value),
                benefice_report_infra_par_m3: parseFloat(document.getElementById('report-infra-m3').value),
                mc_seed: parseInt(document.getElementById('montecarlo-seed').value || "42"),
                mc_n_simulations: parseInt(document.getElementById('montecarlo-sims').value || "500"),
            };

            // Ajouter les param√®tres avanc√©s si mode custom
            if (params.scenario_fuites === 'custom') {
                // Pr√©valence et d√©bits (petites + grosses s√©par√©ment)
                params.prevalence_petites_pct = parseFloat(document.getElementById('prevalence-petites').value);
                params.debit_petites_m3 = parseFloat(document.getElementById('debit-petites').value);
                params.prevalence_grosses_pct = parseFloat(document.getElementById('prevalence-grosses').value);
                params.debit_grosses_m3 = parseFloat(document.getElementById('debit-grosses').value);
                // D√©tection et r√©paration
                params.taux_detection_pct = parseFloat(document.getElementById('taux-detection').value);
                params.taux_reparation_pct = parseFloat(document.getElementById('taux-reparation').value);
                params.facteur_detection_sig = parseFloat(document.getElementById('facteur-detection-sig').value);
                params.facteur_reparation_sig = parseFloat(document.getElementById('facteur-reparation-sig').value);
                // Dynamique temporelle
                params.taux_nouvelles_fuites_pct = parseFloat(document.getElementById('nouvelles-fuites').value);
                params.part_persistantes_pct = parseFloat(document.getElementById('persistantes').value);
                params.facteur_duree_longue_traine = parseFloat(document.getElementById('longue-traine').value);
                // Co√ªts de r√©paration
                params.cout_reparation_petite = parseFloat(document.getElementById('cout-petite').value);
                params.cout_reparation_grosse = parseFloat(document.getElementById('cout-grosse').value);
                params.part_ville_pct = parseFloat(document.getElementById('part-ville').value);
                params.inclure_cout_reparation = document.getElementById('inclure-couts').checked;
            }

            if (params.scenario_adoption === 'custom') {
                params.adoption_max_pct = parseFloat(document.getElementById('adoption-max').value);
                params.adoption_k_vitesse = parseFloat(document.getElementById('adoption-k').value);
                params.adoption_t0_point_median = parseFloat(document.getElementById('adoption-t0').value);
                params.adoption_etaler_capex = document.getElementById('adoption-etaler-capex').checked;
            }

            params.reseau_activer = document.getElementById('reseau-activer').checked;
            if (params.reseau_activer) {
                params.reseau_volume_pertes_m3_an = parseFloat(document.getElementById('reseau-volume').value || "0");
                params.reseau_reduction_max_pct = parseFloat(document.getElementById('reseau-reduc-max').value);
                params.reseau_mode_reduction = document.getElementById('reseau-mode').value;
                params.reseau_annees_atteinte = parseInt(document.getElementById('reseau-annees').value);
                params.reseau_pondere_par_adoption = document.getElementById('reseau-pondere').checked;
            }

            // Mode Expert: synchroniser OPEX d√©taill√© si pr√©sent
            if (document.getElementById('opex-cyber')) {
                const opexTotal = parseFloat(document.getElementById('opex-cyber').value) +
                                  parseFloat(document.getElementById('opex-licences').value) +
                                  parseFloat(document.getElementById('opex-stockage').value) +
                                  parseFloat(document.getElementById('opex-telecom').value);
                // Mettre √† jour le champ principal OPEX AMI
                document.getElementById('opex-ami').value = opexTotal;
                params.cout_opex_non_tech_ami = opexTotal;
            }

            // Mode Expert: param√®tres avanc√©s de persistance
            if (document.getElementById('lambda-decay')) {
                // Uniquement si mode r√©aliste (les autres presets n'utilisent pas ces params)
                if (params.persistance === 'realiste') {
                    params.expert_lambda_decay = parseFloat(document.getElementById('lambda-decay').value);
                    params.expert_alpha_plateau = parseFloat(document.getElementById('alpha-plateau').value);
                }
            }

            // Mode Expert: MCF (optionnel)
            if (document.getElementById('appliquer-mcf')) {
                params.appliquer_mcf = document.getElementById('appliquer-mcf').checked;
                params.mcf = parseFloat(document.getElementById('mcf').value);
            }

            return params;
        }

        function isSansTarifScenario(key) {
            return (key || "").endsWith("_sans_tarif");
        }

        function hasOption(selectEl, value) {
            return Array.from(selectEl.options).some(o => o.value === value);
        }

        function onScenarioFuitesChange() {
            const scenario = document.getElementById('scenario-fuites').value;
            const advancedSection = document.getElementById('advanced-fuites');

            if (scenario === 'custom') {
                advancedSection.style.display = 'block';
                document.getElementById('content-fuites').classList.add('open');
                document.getElementById('chevron-fuites').classList.add('open');
            } else {
                advancedSection.style.display = 'none';
            }

            const hasSignalPrix = !isSansTarifScenario(scenario);
            document.getElementById('tarification').checked = hasSignalPrix;
            updateSignalPrixIndicator(hasSignalPrix);

            updateScenarioBadge();
            onParamChange();
        }

        function onTarificationToggle() {
            const checked = document.getElementById('tarification').checked;
            const sel = document.getElementById('scenario-fuites');
            const key = sel.value;

            if (checked && isSansTarifScenario(key)) {
                const base = key.replace("_sans_tarif", "");
                if (hasOption(sel, base)) sel.value = base;
            }

            if (!checked && !isSansTarifScenario(key)) {
                const sans = key + "_sans_tarif";
                if (hasOption(sel, sans)) sel.value = sans;
            }

            updateSignalPrixIndicator(checked);
            onScenarioFuitesChange();
        }

        function updateSignalPrixIndicator(hasSignalPrix) {
            const box = document.getElementById('signal-prix-box');
            const status = document.getElementById('signal-prix-status');
            const rate = document.getElementById('signal-prix-rate');

            if (hasSignalPrix) {
                box.classList.add('active');
                status.textContent = 'Avec signal-prix';
                rate.innerHTML = '‚Üí Taux r√©paration: <b>85%</b>';
            } else {
                box.classList.remove('active');
                status.textContent = 'Sans signal-prix';
                rate.innerHTML = '‚Üí Taux r√©paration: <b>55%</b>';
            }
        }

        function onScenarioAdoptionChange() {
            const scenario = document.getElementById('scenario-adoption').value;
            document.getElementById('advanced-adoption').style.display = (scenario === "custom") ? "block" : "none";
            onParamChange();
        }

        function onReseauToggle() {
            const on = document.getElementById('reseau-activer').checked;
            document.getElementById('advanced-reseau').style.display = on ? 'block' : 'none';
            onParamChange();
        }

        function onValeurEauPresetChange() {
            onParamChange();
        }

        // Toggle sidebar pour mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
            const btn = document.getElementById('sidebar-toggle');
            btn.setAttribute('aria-expanded', !sidebar.classList.contains('collapsed'));
        }

        function toggleAdvanced() {
            const content = document.getElementById('content-fuites');
            const chevron = document.getElementById('chevron-fuites');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        function toggleHypotheses() {
            const content = document.getElementById('hypotheses-content');
            const chevron = document.getElementById('chevron-hypotheses');
            const isOpen = content.style.display !== 'none';
            content.style.display = isOpen ? 'none' : 'block';
            chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        function toggleMethodo() {
            const content = document.getElementById('methodo-content');
            const chevron = document.getElementById('chevron-methodo');
            const isOpen = content.style.display !== 'none';
            content.style.display = isOpen ? 'none' : 'block';
            chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        function updateHypotheses(params, result) {
            // Projet
            document.getElementById('hyp-projet').innerHTML = `
                <div style="color: #6b7280; line-height: 1.6;">
                    ‚Ä¢ M√©nages: <b>${params.nb_menages.toLocaleString('fr-CA')}</b><br>
                    ‚Ä¢ Taille m√©nage: <b>${params.taille_menage} pers.</b><br>
                    ‚Ä¢ Horizon: <b>${params.horizon} ans</b><br>
                    ‚Ä¢ Taux actualisation: <b>${params.taux_actualisation}%</b>
                </div>
            `;

            // Co√ªts (NOUVEAU)
            const opexAmi = params.cout_opex_non_tech_ami || 15;
            const opexLevel = opexAmi <= 12 ? 'Bas' : opexAmi <= 20 ? 'M√©dian' : 'Haut';
            const coutTotal = params.cout_compteur + (params.heures_installation * params.taux_horaire) + params.cout_reseau;
            document.getElementById('hyp-couts').innerHTML = `
                <div style="color: #6b7280; line-height: 1.6;">
                    ‚Ä¢ Compteur: <b>${params.type_compteur.toUpperCase()}</b><br>
                    ‚Ä¢ Co√ªt unitaire: <b>${params.cout_compteur}$</b><br>
                    ‚Ä¢ Install. + r√©seau: <b>${(params.heures_installation * params.taux_horaire + params.cout_reseau).toFixed(0)}$</b><br>
                    ‚Ä¢ <span style="color: #0369a1;">OPEX non-tech: <b>${opexAmi}$/an</b> (${opexLevel})</span><br>
                    ‚Ä¢ Co√ªt/compteur total: <b>${result.cout_par_compteur?.toFixed(0) || coutTotal.toFixed(0)}$</b>
                </div>
            `;

            // D√©ploiement/Adoption (NOUVEAU)
            const adoptionLabels = {
                'obligatoire': 'Obligatoire (100% an 1)',
                'rapide': 'Rapide (3-4 ans)',
                'progressive': 'Progressive (5-7 ans)',
                'lent': 'Lent (10+ ans)',
                'nouveaux': 'Nouveaux branchements',
                'par_secteur': 'Par secteur',
                'secteur': 'Par secteur',
                'custom': 'Personnalis√©'
            };
            const adoptionLabel = adoptionLabels[params.scenario_adoption] || params.scenario_adoption;
            document.getElementById('hyp-deploiement').innerHTML = `
                <div style="color: #6b7280; line-height: 1.6;">
                    ‚Ä¢ Strat√©gie: <b>${adoptionLabel}</b><br>
                    ‚Ä¢ Investissement: <b>${(result.investissement_initial/1e6).toFixed(1)} M$</b><br>
                    ${params.scenario_adoption === 'custom' ? `
                        ‚Ä¢ Mode: <b>${params.adoption_mode || 'logistique'}</b><br>
                        ‚Ä¢ Taux max: <b>${params.adoption_max_pct || 100}%</b>
                    ` : ''}
                    ${params.activer_economies_echelle ? `‚Ä¢ <span style="color: #059669;">√âco. d'√©chelle: <b>activ√©es</b></span>` : ''}
                </div>
            `;

            // Fuites (enrichi avec param√®tres du mod√®le)
            const scenarioFuites = params.scenario_fuites;
            const hasTarif = !scenarioFuites.includes('sans_tarif');
            const tarifNote = hasTarif ? ' <span style="color:#059669;">(avec signal-prix)</span>' : ' <span style="color:#dc2626;">(sans signal-prix)</span>';

            // Param√®tres fuites selon sc√©nario (valeurs utilis√©es par le mod√®le)
            const fuitesDefaults = {
                'deux_stocks_sans_tarif': { taux_rep: 55, taux_det: 90, prev: '24+6%' },
                'deux_stocks': { taux_rep: 70, taux_det: 90, prev: '24+6%' },
                'quebec_sans_tarif': { taux_rep: 55, taux_det: 85, prev: '35%' },
                'quebec': { taux_rep: 70, taux_det: 85, prev: '35%' },
                'menage_sans_tarif': { taux_rep: 55, taux_det: 80, prev: '20%' },
                'standard': { taux_rep: 70, taux_det: 80, prev: '20%' },
            };
            const fuitesParams = fuitesDefaults[scenarioFuites] || { taux_rep: '?', taux_det: '?', prev: '?' };

            document.getElementById('hyp-fuites').innerHTML = `
                <div style="color: #6b7280; line-height: 1.6;">
                    ‚Ä¢ Sc√©nario: <b>${scenarioFuites}</b>${tarifNote}<br>
                    ‚Ä¢ Pr√©valence: <b>${params.scenario_fuites === 'custom' ? (params.prevalence_petites_pct + params.prevalence_grosses_pct) + '%' : fuitesParams.prev}</b><br>
                    ‚Ä¢ Taux d√©tection: <b>${params.scenario_fuites === 'custom' ? params.taux_detection_pct : fuitesParams.taux_det}%</b><br>
                    ‚Ä¢ Taux r√©paration: <b>${params.scenario_fuites === 'custom' ? params.taux_reparation_pct : fuitesParams.taux_rep}%</b><br>
                    ‚Ä¢ √âconomie: <b>${result.economie_fuite_menage.toFixed(1)} m¬≥/an</b>
                </div>
            `;

            // Comportement
            document.getElementById('hyp-comportement').innerHTML = `
                <div style="color: #6b7280; line-height: 1.6;">
                    ‚Ä¢ LPCD: <b>${params.lpcd} L/pers/jour</b><br>
                    ‚Ä¢ R√©duction initiale: <b>${params.reduction_comportement}%</b><br>
                    ‚Ä¢ Persistance: <b>${params.persistance}</b><br>
                    ‚Ä¢ √âconomie: <b>${result.economie_comportement_menage.toFixed(1)} m¬≥/an</b><br>
                    ‚Ä¢ Usage base: <b>${result.usage_base_menage?.toFixed(0) || '-'} m¬≥/an</b>
                </div>
            `;

            // Valorisation
            const reportInfraAnnuel = params.benefice_report_infra_annuel || 0;
            const reportInfraM3 = params.benefice_report_infra_par_m3 || 0;
            document.getElementById('hyp-valorisation').innerHTML = `
                <div style="color: #6b7280; line-height: 1.6;">
                    ‚Ä¢ Mode: <b>${params.mode_economique ? '√âconomique' : 'Financier'}</b><br>
                    ‚Ä¢ Valeur eau: <b>${params.valeur_sociale} $/m¬≥</b><br>
                    ‚Ä¢ Co√ªt variable: <b>${params.cout_variable} $/m¬≥</b><br>
                    ${reportInfraAnnuel > 0 || reportInfraM3 > 0 ? `‚Ä¢ Report infra: <b>${reportInfraAnnuel > 0 ? (reportInfraAnnuel/1000).toFixed(0)+'k$/an' : ''} ${reportInfraM3 > 0 ? reportInfraM3.toFixed(2)+'$/m¬≥' : ''}</b>` : '‚Ä¢ Report infra: <b>non activ√©</b>'}
                </div>
            `;
        }

        function stableStringify(obj) {
            if (obj === null || typeof obj !== 'object') {
                return JSON.stringify(obj);
            }
            if (Array.isArray(obj)) {
                return '[' + obj.map(stableStringify).join(',') + ']';
            }
            return '{' + Object.keys(obj).sort().map(key => {
                return JSON.stringify(key) + ':' + stableStringify(obj[key]);
            }).join(',') + '}';
        }

        function cacheSet(key, value) {
            if (apiCache.size >= API_CACHE_LIMIT) {
                const firstKey = apiCache.keys().next().value;
                apiCache.delete(firstKey);
            }
            apiCache.set(key, value);
        }

        async function apiCall(endpoint, data = null, useAbort = false) {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            // Si useAbort, annuler les requ√™tes pr√©c√©dentes et cr√©er un nouveau contr√¥leur
            let abortController = null;
            if (useAbort) {
                if (currentAbortController) {
                    currentAbortController.abort();
                }
                abortController = new AbortController();
                currentAbortController = abortController;
            }

            try {
                const options = {
                    method: data ? 'POST' : 'GET',
                    headers: { 'Content-Type': 'application/json' },
                };
                if (data) options.body = JSON.stringify(data);
                if (abortController) options.signal = abortController.signal;

                const baseEndpoint = endpoint.split('?')[0];
                if (data && CACHEABLE_ENDPOINTS.has(baseEndpoint)) {
                    const cacheKey = `${baseEndpoint}|${stableStringify(data)}`;
                    if (apiCache.has(cacheKey)) {
                        return apiCache.get(cacheKey);
                    }
                    const response = await fetch(`${API_URL}${endpoint}`, options);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const result = await response.json();
                    cacheSet(cacheKey, result);
                    return result;
                }

                const response = await fetch(`${API_URL}${endpoint}`, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (e) {
                if (e.name === 'AbortError') {
                    // Requ√™te annul√©e, c'est normal
                    return null;
                }
                console.error('API Error:', e);
                throw e;
            } finally {
                loading.classList.remove('active');
            }
        }

        function onParamChange() {
            updateLabels();
            if (suppressParamChange) return;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updateModel, 200);
        }

        function updateLabels() {
            document.getElementById('val-menages').textContent = parseInt(document.getElementById('nb-menages').value).toLocaleString('fr-CA');
            document.getElementById('val-taille').textContent = parseFloat(document.getElementById('taille-menage').value).toFixed(2);
            document.getElementById('val-lpcd').textContent = document.getElementById('lpcd').value;
            document.getElementById('val-horizon').textContent = document.getElementById('horizon').value;
            document.getElementById('val-taux').textContent = parseFloat(document.getElementById('taux-actualisation').value).toFixed(1);
            document.getElementById('val-cout-compteur').textContent = document.getElementById('cout-compteur').value + ' $';
            document.getElementById('val-heures').textContent = parseFloat(document.getElementById('heures-install').value).toFixed(1) + ' h';
            document.getElementById('val-taux-horaire').textContent = document.getElementById('taux-horaire').value + ' $/h';
            document.getElementById('val-cout-reseau').textContent = document.getElementById('cout-reseau').value + ' $/u';
            const coutInfraFixe = parseFloat(document.getElementById('cout-infra-fixe').value);
            document.getElementById('val-cout-infra-fixe').textContent = coutInfraFixe >= 1000000
                ? (coutInfraFixe / 1000000).toFixed(1) + ' M$'
                : (coutInfraFixe / 1000).toFixed(0) + ' k$';
            document.getElementById('val-opex-ami').textContent = document.getElementById('opex-ami').value + ' $/an';
            document.getElementById('val-reduction').textContent = parseFloat(document.getElementById('reduction-comportement').value).toFixed(1) + ' %';
            document.getElementById('val-valeur-sociale').textContent = parseFloat(document.getElementById('valeur-sociale').value).toFixed(2) + ' $/m¬≥';
            document.getElementById('val-cout-variable').textContent = parseFloat(document.getElementById('cout-variable').value).toFixed(2) + ' $/m¬≥';

            // Labels report d'infrastructure
            const reportAnnuel = parseFloat(document.getElementById('report-infra-annuel').value);
            document.getElementById('val-report-infra-annuel').textContent = reportAnnuel >= 1000
                ? (reportAnnuel / 1000).toFixed(0) + ' k$/an'
                : reportAnnuel.toFixed(0) + ' $/an';
            document.getElementById('val-report-infra-m3').textContent = parseFloat(document.getElementById('report-infra-m3').value).toFixed(2) + ' $/m¬≥';

            // Labels param√®tres avanc√©s fuites
            const prevPetites = parseFloat(document.getElementById('prevalence-petites').value);
            const prevGrosses = parseFloat(document.getElementById('prevalence-grosses').value);
            document.getElementById('val-prevalence-petites').textContent = prevPetites + ' %';
            document.getElementById('val-debit-petites').textContent = document.getElementById('debit-petites').value + ' m¬≥/an';
            document.getElementById('val-prevalence-grosses').textContent = prevGrosses + ' %';
            // Calculer et afficher le total
            document.getElementById('val-prevalence-total-calc').textContent = (prevPetites + prevGrosses).toFixed(0);
            document.getElementById('val-debit-grosses').textContent = document.getElementById('debit-grosses').value + ' m¬≥/an';
            document.getElementById('val-taux-detection').textContent = document.getElementById('taux-detection').value + ' %';
            document.getElementById('val-taux-reparation').textContent = document.getElementById('taux-reparation').value + ' %';
            document.getElementById('val-facteur-detection-sig').textContent = '√ó' + parseFloat(document.getElementById('facteur-detection-sig').value).toFixed(1);
            document.getElementById('val-facteur-reparation-sig').textContent = '√ó' + parseFloat(document.getElementById('facteur-reparation-sig').value).toFixed(1);
            document.getElementById('val-nouvelles-fuites').textContent = document.getElementById('nouvelles-fuites').value + ' %';
            document.getElementById('val-persistantes').textContent = document.getElementById('persistantes').value + ' %';
            document.getElementById('val-longue-traine').textContent = '√ó' + parseFloat(document.getElementById('longue-traine').value).toFixed(1);
            document.getElementById('val-cout-petite').textContent = document.getElementById('cout-petite').value + ' $';
            document.getElementById('val-cout-grosse').textContent = document.getElementById('cout-grosse').value + ' $';
            document.getElementById('val-part-ville').textContent = document.getElementById('part-ville').value + ' %';

            if (document.getElementById('val-adoption-max')) {
                document.getElementById('val-adoption-max').textContent = document.getElementById('adoption-max').value + ' %';
                document.getElementById('val-adoption-k').textContent = parseFloat(document.getElementById('adoption-k').value).toFixed(2);
                document.getElementById('val-adoption-t0').textContent = document.getElementById('adoption-t0').value;
            }

            if (document.getElementById('val-reseau-reduc-max')) {
                document.getElementById('val-reseau-reduc-max').textContent = document.getElementById('reseau-reduc-max').value + ' %';
            }

            const isAMI = document.getElementById('type-compteur').value === 'ami';
            document.getElementById('cout-reseau-group').style.display = isAMI ? 'block' : 'none';
            document.getElementById('cout-infra-fixe-group').style.display = isAMI ? 'block' : 'none';
            document.getElementById('opex-ami-group').style.display = isAMI ? 'block' : 'none';

            // Labels Mode Expert
            if (document.getElementById('val-mcf')) {
                document.getElementById('val-mcf').textContent = parseFloat(document.getElementById('mcf').value).toFixed(2);
                document.getElementById('val-lambda-decay').textContent = parseFloat(document.getElementById('lambda-decay').value).toFixed(2);
                document.getElementById('val-alpha-plateau').textContent = parseFloat(document.getElementById('alpha-plateau').value).toFixed(1);
                document.getElementById('val-externalites').textContent = parseFloat(document.getElementById('externalites').value).toFixed(2) + ' $/m¬≥';

                // OPEX d√©taill√©
                const cyber = parseFloat(document.getElementById('opex-cyber').value);
                const licences = parseFloat(document.getElementById('opex-licences').value);
                const stockage = parseFloat(document.getElementById('opex-stockage').value);
                const telecom = parseFloat(document.getElementById('opex-telecom').value);
                document.getElementById('val-opex-cyber').textContent = cyber.toFixed(2) + ' $/u/an';
                document.getElementById('val-opex-licences').textContent = licences.toFixed(2) + ' $/u/an';
                document.getElementById('val-opex-stockage').textContent = stockage.toFixed(2) + ' $/u/an';
                document.getElementById('val-opex-telecom').textContent = telecom.toFixed(2) + ' $/u/an';
                document.getElementById('val-opex-total').textContent = (cyber + licences + stockage + telecom).toFixed(2) + ' $/u/an';
            }
        }

        async function updateModel() {
            try {
                const params = collectParams();
                const result = await apiCall('/api/calculate', params, true);  // useAbort=true
                if (!result) return;  // Requ√™te annul√©e
                updateDisplay(result);
                updateHypotheses(params, result);
                updateScenarioBadge();

                // Calibration warnings disabled (too noisy)
                document.getElementById('calibration-warnings').style.display = 'none';

                const [sensitivity, meters, persistence] = await Promise.all([
                    apiCall('/api/sensitivity', params),
                    apiCall('/api/compare_meters', params),
                    apiCall('/api/compare_persistence', params),
                ]);

                updateSensitivityChart(sensitivity);
                updateMetersChart(meters);
                updatePersistenceChart(persistence, result);

                // Fetch detailed series and fuites comparison
                try {
                    const detailed = await apiCall('/api/detailed_series', params);
                    updateDetailedCharts(detailed);
                    updateParamsTables(detailed);
                } catch (e) {
                    console.warn('detailed_series endpoint not available yet:', e);
                }

                // Comparaison sc√©narios fuites
                await updateFuitesComparison(params, result);

                await updatePerspectivesChart(params);

            } catch (e) {
                console.error('Model update error:', e);
                const recEl = document.getElementById('recommendation');
                recEl.className = 'recommendation negative';
                recEl.innerHTML = `
                    <div class="recommendation-icon"><i data-lucide="wifi-off"></i></div>
                    <div class="recommendation-text">
                        <strong>Erreur de connexion</strong><br>
                        V√©rifiez que le serveur API est en cours d'ex√©cution.
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function formatMoney(value) {
            const locale = currentLang === 'en' ? 'en-CA' : 'fr-CA';
            const fmt = (n, decimals) => new Intl.NumberFormat(locale, {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(n);

            if (Math.abs(value) >= 1e9) return fmt(value / 1e9, 2) + ' G$';
            if (Math.abs(value) >= 1e6) return fmt(value / 1e6, 1) + ' M$';
            if (Math.abs(value) >= 1e3) return fmt(value / 1e3, 0) + ' k$';
            return fmt(value, 0) + ' $';
        }

        function updateDisplay(result) {
            document.getElementById('metric-van').textContent = formatMoney(result.van);
            document.getElementById('metric-rbc').textContent = result.rbc.toFixed(2);
            document.getElementById('metric-payback').textContent = result.payback ? result.payback.toFixed(1) : '>20';
            document.getElementById('metric-lcsw').textContent = result.lcsw.toFixed(2);
            document.getElementById('metric-invest').textContent = formatMoney(result.investissement_initial);
            document.getElementById('metric-economies').textContent = result.economie_totale_menage.toFixed(1);

            const rbcCard = document.getElementById('rbc-card');
            rbcCard.className = 'metric-card ' + (result.rbc >= 1 ? 'success' : 'danger');

            const recEl = document.getElementById('recommendation');
            if (result.viable) {
                recEl.className = 'recommendation positive';
                recEl.innerHTML = `
                    <div class="recommendation-icon"><i data-lucide="check-circle"></i></div>
                    <div class="recommendation-text">
                        <strong>PROJET √âCONOMIQUEMENT VIABLE</strong><br>
                        ${result.recommandation}
                    </div>
                `;
            } else if (result.van > 0) {
                recEl.className = 'recommendation warning';
                recEl.innerHTML = `
                    <div class="recommendation-icon"><i data-lucide="alert-triangle"></i></div>
                    <div class="recommendation-text">
                        <strong>PROJET MARGINAL</strong><br>
                        ${result.recommandation}
                    </div>
                `;
            } else {
                recEl.className = 'recommendation negative';
                recEl.innerHTML = `
                    <div class="recommendation-icon"><i data-lucide="x-circle"></i></div>
                    <div class="recommendation-text">
                        <strong>PROJET NON RENTABLE</strong><br>
                        ${result.recommandation}
                    </div>
                `;
            }
            lucide.createIcons();

            charts.van.data.labels = result.annees;
            charts.van.data.datasets[0].data = result.van_cumulative.map(v => v / 1e6);
            charts.van.update('none');

            // Mise √† jour du graphique waterfall
            const waterfallData = [
                -result.investissement_initial / 1e6,
                -result.va_couts_exploitation / 1e6,
                (result.va_benefices_eau || result.va_benefices) / 1e6,
                (result.va_benefices_report_infra || 0) / 1e6,
                result.van / 1e6
            ];
            charts.waterfall.data.datasets[0].data = waterfallData;
            // Ajuster les couleurs selon le signe
            charts.waterfall.data.datasets[0].backgroundColor = waterfallData.map((v, i) => {
                if (i === 4) return v >= 0 ? chartColors.success : chartColors.danger;  // VAN
                return v >= 0 ? chartColors.success : chartColors.danger;
            });
            charts.waterfall.update('none');

            charts.alpha.data.labels = result.annees;
            charts.alpha.data.datasets[0].data = result.serie_alpha;
            charts.alpha.update('none');

            document.getElementById('breakdown-body').innerHTML = `
                <tr><td>B√©n√©fices actualis√©s</td><td>${formatMoney(result.va_benefices)}</td></tr>
                <tr><td>Investissement initial</td><td>${formatMoney(-result.investissement_initial)}</td></tr>
                <tr><td>Co√ªts d'exploitation (VA)</td><td>${formatMoney(-result.va_couts_exploitation)}</td></tr>
                <tr><td>Co√ªt par compteur install√©</td><td>${result.cout_par_compteur.toFixed(0)} $</td></tr>
                <tr><td><strong>Valeur Actualis√©e Nette</strong></td><td><strong>${formatMoney(result.van)}</strong></td></tr>
            `;

            document.getElementById('water-breakdown').innerHTML = `
                <tr><td>Usage de base annuel</td><td>${result.usage_base_menage.toFixed(1)} m¬≥</td></tr>
                <tr><td>√âconomie comportementale</td><td>${result.economie_comportement_menage.toFixed(2)} m¬≥</td></tr>
                <tr><td>√âconomie d√©tection fuites</td><td>${result.economie_fuite_menage.toFixed(2)} m¬≥</td></tr>
                <tr><td><strong>Total √©conomies/m√©nage</strong></td><td><strong>${result.economie_totale_menage.toFixed(1)} m¬≥/an</strong></td></tr>
            `;
        }

        function updateSensitivityChart(data) {
            charts.sensitivity.data.labels = data.parametres.map(p => p.nom);
            charts.sensitivity.data.datasets[0].data = data.parametres.map(p => p.impact_low / 1e6);
            charts.sensitivity.data.datasets[1].data = data.parametres.map(p => p.impact_high / 1e6);
            charts.sensitivity.update('none');
        }

        function updateMetersChart(data) {
            charts.types.data.datasets[0].data = [data.ami.van / 1e6, data.amr.van / 1e6, data.manuel.van / 1e6];
            charts.types.update('none');
        }

        function updatePersistenceChart(data, currentResult) {
            charts.persistance.data.labels = currentResult.annees;
            charts.persistance.data.datasets[0].data = data.optimiste.van_cumulative.map(v => v / 1e6);
            charts.persistance.data.datasets[1].data = data.realiste.van_cumulative.map(v => v / 1e6);
            charts.persistance.data.datasets[2].data = data.pessimiste.van_cumulative.map(v => v / 1e6);
            charts.persistance.update('none');
        }

        function updateDetailedCharts(data) {
            // Graphique dynamique des fuites (avec ann√©e 0 = stock initial)
            charts.fuites.data.labels = data.annees_fuites || data.annees;
            charts.fuites.data.datasets[0].data = data.stock_fuites_pct;
            charts.fuites.update('none');

            // Graphique d√©composition des √©conomies
            charts.decomposition.data.labels = data.annees;
            charts.decomposition.data.datasets[0].data = data.economies_comportement_m3;
            charts.decomposition.data.datasets[1].data = data.economies_fuites_m3;
            charts.decomposition.update('none');
        }

        function updateParamsTables(data) {
            const pf = data.params_fuites;
            const pp = data.params_persistance;

            // Table param√®tres fuites
            // Note: pf.prevalence_petites_pct = total (petites + grosses) dans l'API
            const totalPrev = pf.prevalence_petites_pct;
            const grossesPrev = pf.prevalence_grosses_pct;
            const petitesPrev = totalPrev - grossesPrev;

            const fuitesHtml = pf.mode_deux_stocks ? `
                <tr><td>Petites fuites</td><td>${petitesPrev.toFixed(0)}% √† ${pf.debit_petites_m3.toFixed(0)} m¬≥/an</td></tr>
                <tr><td>Grosses fuites</td><td>${grossesPrev.toFixed(1)}% √† ${pf.debit_grosses_m3.toFixed(0)} m¬≥/an</td></tr>
                <tr><td><strong>Total pr√©valence</strong></td><td><strong>${totalPrev.toFixed(0)}% des m√©nages</strong></td></tr>
                <tr><td>Taux d√©tection AMI</td><td>${pf.taux_detection_pct.toFixed(0)}%</td></tr>
                <tr><td>Taux r√©paration (base)</td><td>${pf.taux_reparation_pct.toFixed(0)}%</td></tr>
                <tr><td>Nouvelles fuites/an</td><td>${pf.taux_nouvelles_fuites_pct.toFixed(1)}%</td></tr>
                <tr><td>Fuites persistantes</td><td>${pf.part_persistantes_pct.toFixed(0)}%</td></tr>
                <tr><td><strong>Total r√©parations</strong></td><td><strong>${data.total_reparations.toLocaleString('fr-CA')}</strong></td></tr>
            ` : `
                <tr><td>Mode</td><td>Stock unique agr√©g√©</td></tr>
                <tr><td>Pr√©valence</td><td>${totalPrev.toFixed(0)}%</td></tr>
                <tr><td>D√©bit moyen</td><td>${pf.debit_petites_m3.toFixed(0)} m¬≥/an</td></tr>
                <tr><td>Taux r√©paration</td><td>${pf.taux_reparation_pct.toFixed(0)}%</td></tr>
                <tr><td><strong>Total r√©parations</strong></td><td><strong>${data.total_reparations.toLocaleString('fr-CA')}</strong></td></tr>
            `;
            document.getElementById('fuites-params-body').innerHTML = fuitesHtml;

            // Table param√®tres persistance
            const modeNames = {
                'CONSTANT': 'Constant (optimiste)',
                'EXPONENTIEL_PLATEAU': 'Exponentiel avec plateau (r√©aliste)',
                'FADEOUT_LINEAIRE': 'Fadeout lin√©aire (pessimiste)',
            };
            const modeName = modeNames[pp.mode] || pp.mode;

            document.getElementById('persistance-params-body').innerHTML = `
                <tr><td>Sc√©nario</td><td>${pp.scenario}</td></tr>
                <tr><td>Mode math√©matique</td><td>${modeName}</td></tr>
                <tr><td>Œ± initial (ann√©e 1)</td><td>${pp.alpha_initial_pct.toFixed(1)}%</td></tr>
                <tr><td>Œ± plateau (long terme)</td><td>${pp.alpha_plateau_pct.toFixed(1)}%</td></tr>
                <tr><td><strong>√âconomies eau totales</strong></td><td><strong>${(data.economies_eau_total_m3 / 1e6).toFixed(2)} Mm¬≥</strong></td></tr>
            `;
        }

        async function updatePerspectivesChart(params) {
            try {
                const persp = await apiCall('/api/perspectives', params);
                if (!persp) return;

                const data = [
                    persp.van_economique / 1e6,
                    persp.van_ville / 1e6,
                    persp.van_menages / 1e6
                ];

                charts.perspectives.data.datasets[0].data = data;
                // Colorer selon positif/n√©gatif
                charts.perspectives.data.datasets[0].backgroundColor = data.map(v =>
                    v >= 0 ? chartColors.success : chartColors.danger
                );
                charts.perspectives.update('none');
            } catch (e) {
                console.warn('Perspectives chart update failed:', e);
            }
        }

        async function loadPreset(ville) {
            const presets = {
                longueuil: { nb_menages: 116258, taille_menage: 2.18, lpcd: 236 },
                montreal: { nb_menages: 750000, taille_menage: 2.1, lpcd: 332 },
                quebec: { nb_menages: 180000, taille_menage: 2.15, lpcd: 280 },
                winnipeg: { nb_menages: 221000, taille_menage: 2.3, lpcd: 250 },
            };

            const preset = presets[ville];
            if (!preset) return;

            document.getElementById('nb-menages').value = preset.nb_menages;
            document.getElementById('taille-menage').value = preset.taille_menage;
            document.getElementById('lpcd').value = preset.lpcd;

            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(ville));
            });

            updateLabels();
            await updateModel();
        }

        function setModeEconomique(value) {
            modeEconomique = !!value;
            document.getElementById('mode-toggle').classList.toggle('active', !modeEconomique);
            document.getElementById('mode-label').textContent = modeEconomique
                ? 'Mode √âconomique (valeur sociale)'
                : 'Mode Financier (co√ªt variable)';
        }

        function toggleMode() {
            setModeEconomique(!modeEconomique);
            updateModel();
        }

        // === OPTIMISATION ===
        let optimizationOpen = false;

        function toggleOptimization() {
            optimizationOpen = !optimizationOpen;
            document.getElementById('optimization-section').style.display = optimizationOpen ? 'block' : 'none';
            document.getElementById('optim-toggle-icon').classList.toggle('open', optimizationOpen);
        }

        function updateOptimLabels() {
            const budget = parseFloat(document.getElementById('budget-max').value);
            const capacite = parseInt(document.getElementById('capacite-max').value);
            const horizon = parseInt(document.getElementById('horizon-deploy').value);

            document.getElementById('val-budget-max').textContent = (budget / 1e6).toFixed(1) + ' M$';
            document.getElementById('val-capacite-max').textContent = capacite.toLocaleString() + ' /an';
            document.getElementById('val-horizon-deploy').textContent = horizon + ' ans';
        }

        async function runOptimization() {
            try {
                const params = collectParams();
                const request = {
                    params: params,
                    budget_annuel_max: parseFloat(document.getElementById('budget-max').value),
                    capacite_installation_max: parseInt(document.getElementById('capacite-max').value),
                    objectif: document.getElementById('optim-objectif').value,
                    horizon_deploiement: parseInt(document.getElementById('horizon-deploy').value)
                };

                const result = await apiCall('/api/optimize_deployment', request);

                // Afficher les r√©sultats
                const optimal = result.optimal;
                const resultDiv = document.getElementById('optim-results');
                resultDiv.style.display = 'block';

                document.getElementById('optim-result-text').innerHTML = `
                    <strong>${result.recommandation}</strong><br>
                    VAN: ${formatMoney(optimal.van)}<br>
                    RBC: ${optimal.rbc.toFixed(2)}<br>
                    Budget annuel: ${formatMoney(optimal.budget_annuel)}<br>
                    Payback: ${optimal.payback ? optimal.payback.toFixed(1) + ' ans' : '>20 ans'}
                `;

            } catch (error) {
                console.error('Erreur optimisation:', error);
                alert('Erreur lors de l\'optimisation: ' + error.message);
            }
        }

        // === MODE EXPERT ===
        let expertModeOpen = false;

        function toggleExpertMode() {
            expertModeOpen = !expertModeOpen;
            const section = document.getElementById('expert-section');
            const icon = document.getElementById('expert-toggle-icon');
            section.style.display = expertModeOpen ? 'block' : 'none';
            icon.classList.toggle('open', expertModeOpen);
        }

        function onExpertPresetChange() {
            const preset = document.getElementById('expert-preset').value;

            const presets = {
                standard: {
                    mcf: 0.20, appliquerMcf: false,
                    lambdaDecay: 0.15, alphaPlateau: 2.5,
                    externalites: 0.5,
                    cyber: 3, licences: 5, stockage: 2, telecom: 5
                },
                conservateur: {
                    mcf: 0.25, appliquerMcf: true,
                    lambdaDecay: 0.20, alphaPlateau: 1.5,
                    externalites: 0.3,
                    cyber: 4, licences: 7, stockage: 3, telecom: 6
                },
                agressif: {
                    mcf: 0.15, appliquerMcf: false,
                    lambdaDecay: 0.10, alphaPlateau: 4.0,
                    externalites: 1.0,
                    cyber: 2, licences: 4, stockage: 1.5, telecom: 4
                }
            };

            if (preset !== 'custom' && presets[preset]) {
                const p = presets[preset];
                document.getElementById('mcf').value = p.mcf;
                document.getElementById('appliquer-mcf').checked = p.appliquerMcf;
                document.getElementById('lambda-decay').value = p.lambdaDecay;
                document.getElementById('alpha-plateau').value = p.alphaPlateau;
                document.getElementById('externalites').value = p.externalites;
                document.getElementById('opex-cyber').value = p.cyber;
                document.getElementById('opex-licences').value = p.licences;
                document.getElementById('opex-stockage').value = p.stockage;
                document.getElementById('opex-telecom').value = p.telecom;
                onParamChange();
            }
        }

        function initCharts() {
            // chartColors is defined globally above

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 400,
                    easing: 'easeOutQuart'
                },
                transitions: {
                    active: {
                        animation: {
                            duration: 200
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { family: 'Inter', size: 11 },
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleFont: { family: 'Inter', size: 13, weight: '600' },
                        bodyFont: { family: 'Inter', size: 12 },
                        footerFont: { family: 'Inter', size: 11 },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        boxPadding: 6,
                        caretSize: 6,
                        caretPadding: 8,
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: { color: chartColors.grid, drawBorder: false },
                        ticks: { font: { family: 'Inter', size: 11 } }
                    },
                    y: {
                        grid: { color: chartColors.grid, drawBorder: false },
                        ticks: { font: { family: 'Inter', size: 11 } }
                    }
                }
            };

            charts.van = new Chart(document.getElementById('chart-van').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'VAN Cumulative (M$)',
                        data: [],
                        borderColor: chartColors.primary,
                        backgroundColor: 'rgba(15, 76, 117, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        borderWidth: 3
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: { ...defaultOptions.plugins, legend: { display: false } },
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, title: { display: true, text: 'Ann√©e', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y, title: { display: true, text: 'M$', font: { family: 'Inter', weight: 600 } } }
                    }
                }
            });

            charts.sensitivity = new Chart(document.getElementById('chart-sensitivity').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: '-10%', data: [], backgroundColor: chartColors.danger, borderRadius: 4, barPercentage: 0.8, categoryPercentage: 0.9 },
                        { label: '+10%', data: [], backgroundColor: chartColors.success, borderRadius: 4, barPercentage: 0.8, categoryPercentage: 0.9 }
                    ]
                },
                options: {
                    ...defaultOptions,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            ...defaultOptions.scales.x,
                            stacked: true,
                            title: { display: true, text: 'Impact sur VAN (M$)', font: { family: 'Inter', weight: 600 } }
                        },
                        y: {
                            ...defaultOptions.scales.y,
                            stacked: true,
                            ticks: { font: { family: 'Inter', size: 10 } }
                        }
                    }
                }
            });

            // Waterfall chart - Contribution VAN
            charts.waterfall = new Chart(document.getElementById('chart-waterfall').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Investissement', 'OPEX', 'B√©n√©fices eau', 'Report infra', 'VAN'],
                    datasets: [{
                        label: 'Contribution (M$)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            chartColors.danger,      // Investissement (n√©gatif)
                            chartColors.warning,     // OPEX (n√©gatif)
                            chartColors.success,     // B√©n√©fices eau (positif)
                            chartColors.info,        // Report infra (positif)
                            chartColors.primary      // VAN (r√©sultat)
                        ],
                        borderRadius: 4,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: {
                        ...defaultOptions.plugins,
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw >= 0 ? '+' : ''}${ctx.raw.toFixed(2)} M$`
                            }
                        }
                    },
                    scales: {
                        x: { ...defaultOptions.scales.x },
                        y: {
                            ...defaultOptions.scales.y,
                            title: { display: true, text: 'M$', font: { family: 'Inter', weight: 600 } }
                        }
                    }
                }
            });

            charts.types = new Chart(document.getElementById('chart-types').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['AMI (Intelligent)', 'AMR (Auto)', 'Manuel'],
                    datasets: [{
                        label: 'VAN (M$)',
                        data: [],
                        backgroundColor: [chartColors.primary, chartColors.primaryLight, chartColors.secondary],
                        borderRadius: 8
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: { ...defaultOptions.plugins, legend: { display: false } },
                    scales: {
                        ...defaultOptions.scales,
                        y: { ...defaultOptions.scales.y, title: { display: true, text: 'VAN (M$)', font: { family: 'Inter', weight: 600 } } }
                    }
                }
            });

            charts.persistance = new Chart(document.getElementById('chart-persistance').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Optimiste', data: [], borderColor: chartColors.success, tension: 0.4, pointRadius: 0, borderWidth: 2.5 },
                        { label: 'R√©aliste', data: [], borderColor: chartColors.primary, tension: 0.4, pointRadius: 0, borderWidth: 2.5 },
                        { label: 'Pessimiste', data: [], borderColor: chartColors.danger, tension: 0.4, pointRadius: 0, borderWidth: 2.5 }
                    ]
                },
                options: {
                    ...defaultOptions,
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, title: { display: true, text: 'Ann√©e', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y, title: { display: true, text: 'VAN (M$)', font: { family: 'Inter', weight: 600 } } }
                    }
                }
            });

            charts.alpha = new Chart(document.getElementById('chart-alpha').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Coefficient Œ± (%)',
                        data: [],
                        borderColor: chartColors.secondary,
                        backgroundColor: 'rgba(0, 180, 216, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 3
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: { ...defaultOptions.plugins, legend: { display: false } },
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, title: { display: true, text: 'Ann√©e', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y, title: { display: true, text: 'Œ± (%)', font: { family: 'Inter', weight: 600 } }, min: 0 }
                    }
                }
            });

            charts.perspectives = new Chart(document.getElementById('chart-perspectives').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['√âconomique', 'Ville', 'M√©nages'],
                    datasets: [{
                        label: 'VAN (M$)',
                        data: [],
                        backgroundColor: [chartColors.primary, chartColors.info, chartColors.success],
                        borderRadius: 6
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: {
                        ...defaultOptions.plugins,
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const labels = {
                                        0: 'Bien-√™tre social (externalit√©s incluses)',
                                        1: 'Budget municipal',
                                        2: 'Perspective citoyens'
                                    };
                                    return `${ctx.raw >= 0 ? '+' : ''}${ctx.raw.toFixed(2)} M$ - ${labels[ctx.dataIndex]}`;
                                }
                            }
                        }
                    },
                    scales: {
                        ...defaultOptions.scales,
                        y: { ...defaultOptions.scales.y, title: { display: true, text: 'VAN (M$)', font: { family: 'Inter', weight: 600 } } }
                    }
                }
            });

            // Graphique dynamique des fuites
            charts.fuites = new Chart(document.getElementById('chart-fuites').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '% m√©nages avec fuite active',
                        data: [],
                        borderColor: chartColors.danger,
                        backgroundColor: 'rgba(239, 71, 111, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        borderWidth: 2.5
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: { ...defaultOptions.plugins, legend: { display: false } },
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, title: { display: true, text: 'Ann√©e', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y, title: { display: true, text: '% m√©nages', font: { family: 'Inter', weight: 600 } }, min: 0 }
                    }
                }
            });

            // Graphique d√©composition des √©conomies
            charts.decomposition = new Chart(document.getElementById('chart-decomposition').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Comportement',
                            data: [],
                            backgroundColor: chartColors.primary,
                            borderRadius: 4,
                            stack: 'stack0'
                        },
                        {
                            label: 'D√©tection fuites',
                            data: [],
                            backgroundColor: chartColors.secondary,
                            borderRadius: 4,
                            stack: 'stack0'
                        }
                    ]
                },
                options: {
                    ...defaultOptions,
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, stacked: true, title: { display: true, text: 'Ann√©e', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y, stacked: true, title: { display: true, text: 'm¬≥/m√©nage/an', font: { family: 'Inter', weight: 600 } } }
                    }
                }
            });

            // Graphique comparaison sc√©narios fuites
            charts.fuitesScenarios = new Chart(document.getElementById('chart-fuites-scenarios').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Sans co√ªts (20%)', data: [], borderColor: '#3b82f6', tension: 0.4, pointRadius: 0, borderWidth: 2.5 },
                        { label: 'Qu√©bec (35%)', data: [], borderColor: '#f59e0b', tension: 0.4, pointRadius: 0, borderWidth: 2.5 },
                        { label: 'Diff√©renci√© QC', data: [], borderColor: '#10b981', tension: 0.4, pointRadius: 0, borderWidth: 2.5 }
                    ]
                },
                options: {
                    ...defaultOptions,
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, title: { display: true, text: 'Ann√©e', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y, title: { display: true, text: 'VAN (M$)', font: { family: 'Inter', weight: 600 } } }
                    }
                }
            });

            // Graphique Monte Carlo distribution
            charts.monteCarlo = new Chart(document.getElementById('chart-monte-carlo').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Fr√©quence',
                        data: [],
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1,
                        borderRadius: 2,
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: {
                        ...defaultOptions.plugins,
                        legend: { display: false },
                        annotation: {
                            annotations: {}
                        }
                    },
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, title: { display: true, text: 'VAN (M$)', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y, title: { display: true, text: 'Fr√©quence', font: { family: 'Inter', weight: 600 } } }
                    }
                }
            });

            // Graphique Monte Carlo drivers
            charts.mcDrivers = new Chart(document.getElementById('chart-mc-drivers').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Corr√©lation',
                        data: [],
                        backgroundColor: [],
                        borderRadius: 4,
                    }]
                },
                options: {
                    ...defaultOptions,
                    indexAxis: 'y',
                    plugins: { ...defaultOptions.plugins, legend: { display: false } },
                    scales: {
                        ...defaultOptions.scales,
                        x: { ...defaultOptions.scales.x, min: -1, max: 1, title: { display: true, text: 'Corr√©lation', font: { family: 'Inter', weight: 600 } } },
                        y: { ...defaultOptions.scales.y }
                    }
                }
            });
        }

        // Mise √† jour du bandeau sc√©nario
        function updateScenarioBadge() {
            const persistance = document.getElementById('persistance').value;
            const fuites = document.getElementById('scenario-fuites').value;
            const mode = modeEconomique ? '√âconomique' : 'Financier';

            const persistanceNoms = {
                'optimiste': 'Optimiste',
                'realiste': 'R√©aliste',
                'pessimiste': 'Pessimiste',
                'ultra': 'Ultra-pessimiste'
            };

            const fuitesNoms = {
                'standard': 'Standard (20%)',
                'quebec': 'Qu√©bec (35%)',
                'deux_stocks': 'QC diff√©renci√©',
                'menage': 'M√©nage (40%)',
                'subvention_50': 'Subvention 50%',
                'ville': 'Ville (d√©tection ‚Üë)',
                'menage_sans_tarif': 'M√©nage sans tarif',
                'quebec_sans_tarif': 'Qu√©bec sans tarif',
                'deux_stocks_sans_tarif': 'QC diff√©renci√© sans tarif',
                'custom': 'Personnalis√©'
            };

            const pNom = persistanceNoms[persistance] || persistance;
            const fNom = fuitesNoms[fuites] || fuites;

            document.getElementById('scenario-name').textContent = `${pNom} + ${fNom}`;
            document.getElementById('scenario-details').innerHTML = `
                <span class="tag tag-persistance">${pNom}</span>
                <span class="tag tag-fuites">${fNom}</span>
                <span class="tag tag-mode">${mode}</span>
            `;
        }

        // Comparaison des sc√©narios de fuites
        async function updateFuitesComparison(params, currentResult) {
            try {
                const fuitesData = await apiCall('/api/compare_fuites', params);

                charts.fuitesScenarios.data.labels = currentResult.annees;
                charts.fuitesScenarios.data.datasets[0].label = fuitesData.standard.nom;
                charts.fuitesScenarios.data.datasets[1].label = fuitesData.quebec.nom;
                charts.fuitesScenarios.data.datasets[2].label = fuitesData.deux_stocks.nom;
                charts.fuitesScenarios.data.datasets[0].data = fuitesData.standard.van_cumulative.map(v => v / 1e6);
                charts.fuitesScenarios.data.datasets[1].data = fuitesData.quebec.van_cumulative.map(v => v / 1e6);
                charts.fuitesScenarios.data.datasets[2].data = fuitesData.deux_stocks.van_cumulative.map(v => v / 1e6);
                charts.fuitesScenarios.update('none');
            } catch (e) {
                console.warn('Erreur compare_fuites:', e);
            }
        }

        // Monte Carlo
        let mcRunning = false;

        // === MONTE CARLO DISTRIBUTIONS ===
        function toggleMCDistributions() {
            const section = document.getElementById('mc-distributions-section');
            const icon = document.getElementById('mc-distrib-toggle');
            const isOpen = section.style.display !== 'none';
            section.style.display = isOpen ? 'none' : 'block';
            icon.classList.toggle('open', !isOpen);
        }

        function collectMCDistributions() {
            return [
                {
                    nom: "alpha0",
                    type_distribution: "triangular",
                    min_val: parseFloat(document.getElementById('mc-alpha0-min').value) / 100,
                    mode_val: parseFloat(document.getElementById('mc-alpha0-mode').value) / 100,
                    max_val: parseFloat(document.getElementById('mc-alpha0-max').value) / 100,
                },
                {
                    nom: "lpcd",
                    type_distribution: "triangular",
                    min_val: parseFloat(document.getElementById('mc-lpcd-min').value),
                    mode_val: parseFloat(document.getElementById('mc-lpcd-mode').value),
                    max_val: parseFloat(document.getElementById('mc-lpcd-max').value),
                },
                {
                    nom: "cout_compteur",
                    type_distribution: "triangular",
                    min_val: parseFloat(document.getElementById('mc-cout-min').value),
                    mode_val: parseFloat(document.getElementById('mc-cout-mode').value),
                    max_val: parseFloat(document.getElementById('mc-cout-max').value),
                },
                {
                    nom: "valeur_eau",
                    type_distribution: "triangular",
                    min_val: parseFloat(document.getElementById('mc-valeur-min').value),
                    mode_val: parseFloat(document.getElementById('mc-valeur-mode').value),
                    max_val: parseFloat(document.getElementById('mc-valeur-max').value),
                },
            ];
        }

        function exportMCConfig() {
            const config = {
                distributions: collectMCDistributions(),
                n_simulations: parseInt(document.getElementById('montecarlo-sims').value),
                seed: parseInt(document.getElementById('montecarlo-seed').value),
            };
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "monte-carlo-config.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function importMCConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const text = await file.text();
                try {
                    const config = JSON.parse(text);
                    if (config.distributions) {
                        config.distributions.forEach(d => {
                            if (d.nom === 'alpha0') {
                                document.getElementById('mc-alpha0-min').value = (d.min_val * 100).toFixed(1);
                                document.getElementById('mc-alpha0-mode').value = (d.mode_val * 100).toFixed(1);
                                document.getElementById('mc-alpha0-max').value = (d.max_val * 100).toFixed(1);
                            } else if (d.nom === 'lpcd') {
                                document.getElementById('mc-lpcd-min').value = d.min_val;
                                document.getElementById('mc-lpcd-mode').value = d.mode_val;
                                document.getElementById('mc-lpcd-max').value = d.max_val;
                            } else if (d.nom === 'cout_compteur') {
                                document.getElementById('mc-cout-min').value = d.min_val;
                                document.getElementById('mc-cout-mode').value = d.mode_val;
                                document.getElementById('mc-cout-max').value = d.max_val;
                            } else if (d.nom === 'valeur_eau') {
                                document.getElementById('mc-valeur-min').value = d.min_val;
                                document.getElementById('mc-valeur-mode').value = d.mode_val;
                                document.getElementById('mc-valeur-max').value = d.max_val;
                            }
                        });
                    }
                    if (config.n_simulations) document.getElementById('montecarlo-sims').value = config.n_simulations;
                    if (config.seed) document.getElementById('montecarlo-seed').value = config.seed;
                    document.getElementById('mc-use-custom').checked = true;
                    alert('Configuration import√©e avec succ√®s');
                } catch (err) {
                    alert('Erreur de format JSON');
                }
            };
            input.click();
        }

        async function runMonteCarlo() {
            if (mcRunning) return;

            const btn = document.getElementById('btn-run-mc');
            btn.disabled = true;
            btn.classList.add('loading');
            btn.textContent = 'Simulation...';
            mcRunning = true;

            try {
                const params = collectParams();
                const sims = parseInt(document.getElementById('montecarlo-sims').value || "500");
                const seed = parseInt(document.getElementById('montecarlo-seed').value || "42");
                const useCustom = document.getElementById('mc-use-custom')?.checked;

                let mcResult;
                if (useCustom) {
                    // Utiliser l'endpoint avanc√© avec distributions personnalis√©es
                    const request = {
                        params: params,
                        n_simulations: sims,
                        seed: seed,
                        distributions_custom: collectMCDistributions()
                    };
                    mcResult = await apiCall('/api/monte_carlo_advanced', request);
                } else {
                    // Endpoint standard
                    mcResult = await apiCall(`/api/monte_carlo?n_simulations=${sims}&seed=${seed}`, params);
                }

                // Afficher les stats
                document.getElementById('mc-stats').style.display = 'grid';
                document.getElementById('mc-prob').textContent = (mcResult.prob_van_positive * 100).toFixed(1) + '%';
                document.getElementById('mc-median').textContent = formatMoney(mcResult.van_mediane);
                document.getElementById('mc-ic').textContent = `[${formatMoney(mcResult.percentiles.p5)}, ${formatMoney(mcResult.percentiles.p95)}]`;
                document.getElementById('mc-std').textContent = formatMoney(mcResult.van_std);

                // Mettre √† jour l'histogramme
                charts.monteCarlo.data.labels = mcResult.histogram.bin_centers.map(v => (v / 1e6).toFixed(0));
                charts.monteCarlo.data.datasets[0].data = mcResult.histogram.counts;

                // Colorer les barres selon positif/n√©gatif
                const colors = mcResult.histogram.bin_centers.map(v =>
                    v >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 71, 111, 0.7)'
                );
                charts.monteCarlo.data.datasets[0].backgroundColor = colors;
                charts.monteCarlo.update('none');

                // Mettre √† jour les drivers
                if (mcResult.correlations && mcResult.correlations.length > 0) {
                    charts.mcDrivers.data.labels = mcResult.correlations.map(c => c.param);
                    charts.mcDrivers.data.datasets[0].data = mcResult.correlations.map(c => c.correlation);
                    charts.mcDrivers.data.datasets[0].backgroundColor = mcResult.correlations.map(c =>
                        c.correlation >= 0 ? '#10b981' : '#ef4444'
                    );
                    charts.mcDrivers.update('none');
                }

            } catch (e) {
                console.error('Erreur Monte Carlo:', e);
                alert('Erreur lors de la simulation Monte Carlo. V√©rifiez la console.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = '<i data-lucide="play" class="lucide-sm"></i> Lancer';
                lucide.createIcons();
                mcRunning = false;
            }
        }

        async function exportJSON() {
            try {
                const params = collectParams();
                const result = await apiCall('/api/calculate', params);
                const health = await apiCall('/api/health', null, 'GET');

                // Export complet: inputs + outputs + m√©tadonn√©es
                const exportData = {
                    _meta: {
                        export_timestamp: new Date().toISOString(),
                        model_version: health.version || 'unknown',
                        export_format_version: "2.0"
                    },
                    inputs: params,
                    outputs: {
                        van: result.van,
                        rbc: result.rbc,
                        payback: result.payback,
                        lcsw: result.lcsw,
                        investissement_initial: result.investissement_initial,
                        va_benefices: result.va_benefices,
                        va_couts_exploitation: result.va_couts_exploitation,
                        va_couts_totaux: result.va_couts_totaux,
                        va_benefices_eau: result.va_benefices_eau,
                        va_benefices_report_infra: result.va_benefices_report_infra,
                        va_benefices_cout_variable: result.va_benefices_cout_variable,
                        economie_totale_menage: result.economie_totale_menage,
                        economie_comportement_menage: result.economie_comportement_menage,
                        economie_fuite_menage: result.economie_fuite_menage,
                        usage_base_menage: result.usage_base_menage,
                        cout_par_compteur: result.cout_par_compteur,
                        viable: result.viable,
                        recommandation: result.recommandation
                    },
                    series: {
                        annees: result.annees,
                        van_cumulative: result.van_cumulative,
                        serie_alpha: result.serie_alpha
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `scenario-compteurs-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Erreur export JSON:', error);
                alert('Erreur lors de l\'export: ' + error.message);
            }
        }

        async function exportCSV() {
            try {
                const params = collectParams();
                const result = await apiCall('/api/calculate', params);
                const series = await apiCall('/api/detailed_series', params);

                // Cr√©er le CSV
                let csv = "Analyse CBA Compteurs d'Eau - Export\n\n";

                // Section Param√®tres
                csv += "PARAMETRES\n";
                csv += `M√©nages;${params.nb_menages}\n`;
                csv += `Horizon (ans);${params.horizon}\n`;
                csv += `Taux actualisation (%);${params.taux_actualisation}\n`;
                csv += `Type compteur;${params.type_compteur}\n`;
                csv += `Sc√©nario fuites;${params.scenario_fuites}\n`;
                csv += `Sc√©nario adoption;${params.scenario_adoption}\n`;
                csv += `Persistance;${params.persistance}\n`;
                csv += "\n";

                // Section R√©sultats
                csv += "RESULTATS\n";
                csv += `VAN ($);${result.van.toFixed(0)}\n`;
                csv += `RBC;${result.rbc.toFixed(2)}\n`;
                csv += `Payback (ans);${result.payback ? result.payback.toFixed(1) : '>20'}\n`;
                csv += `LCSW ($/m3);${result.lcsw.toFixed(2)}\n`;
                csv += `Investissement ($);${result.investissement_initial.toFixed(0)}\n`;
                csv += `√âconomie totale (m3/m√©nage/an);${result.economie_totale_menage.toFixed(2)}\n`;
                csv += "\n";

                // Section S√©ries temporelles
                csv += "SERIES TEMPORELLES\n";
                csv += "Ann√©e;VAN Cumulative ($);Alpha (%);√âconomie comportement (m3);√âconomie fuites (m3)\n";
                for (let i = 0; i < result.annees.length; i++) {
                    csv += `${result.annees[i]};${result.van_cumulative[i].toFixed(0)};${result.serie_alpha[i].toFixed(1)};${(series.economies_comportement_m3[i] || 0).toFixed(2)};${(series.economies_fuites_m3[i] || 0).toFixed(2)}\n`;
                }

                // T√©l√©charger
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "analyse-compteurs.csv";
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                alert("Erreur lors de l'export CSV: " + e.message);
            }
        }

        function exportPDF() {
            // Cr√©er une fen√™tre d'impression avec le r√©sum√©
            const params = collectParams();
            const van = document.getElementById('metric-van').textContent;
            const rbc = document.getElementById('metric-rbc').textContent;
            const payback = document.getElementById('metric-payback').textContent;
            const invest = document.getElementById('metric-invest').textContent;
            const economies = document.getElementById('metric-economies').textContent;
            const recommandation = document.getElementById('recommendation').innerText;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Analyse CBA Compteurs d'Eau</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
                        h1 { color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 10px; }
                        h2 { color: #374151; margin-top: 30px; }
                        .metric { display: inline-block; width: 30%; margin: 10px 0; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center; }
                        .metric-value { font-size: 24px; font-weight: bold; color: #1e40af; }
                        .metric-label { font-size: 12px; color: #6b7280; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
                        th { background: #f3f4f6; }
                        .recommandation { padding: 15px; background: ${van.includes('-') ? '#fef2f2' : '#f0fdf4'}; border-radius: 8px; margin: 20px 0; }
                        .footer { margin-top: 40px; font-size: 11px; color: #9ca3af; text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>Analyse Co√ªts-B√©n√©fices Compteurs d'Eau</h1>
                    <p><em>G√©n√©r√© le ${new Date().toLocaleDateString('fr-CA')}</em></p>

                    <h2>R√©sultats cl√©s</h2>
                    <div>
                        <div class="metric"><div class="metric-label">VAN</div><div class="metric-value">${van}</div></div>
                        <div class="metric"><div class="metric-label">RBC</div><div class="metric-value">${rbc}</div></div>
                        <div class="metric"><div class="metric-label">Payback</div><div class="metric-value">${payback} ans</div></div>
                    </div>
                    <div>
                        <div class="metric"><div class="metric-label">Investissement</div><div class="metric-value">${invest}</div></div>
                        <div class="metric"><div class="metric-label">√âconomies</div><div class="metric-value">${economies} m¬≥/an</div></div>
                    </div>

                    <div class="recommandation">${recommandation}</div>

                    <h2>Hypoth√®ses</h2>
                    <table>
                        <tr><th>Param√®tre</th><th>Valeur</th></tr>
                        <tr><td>M√©nages</td><td>${params.nb_menages.toLocaleString('fr-CA')}</td></tr>
                        <tr><td>Horizon</td><td>${params.horizon} ans</td></tr>
                        <tr><td>Taux d'actualisation</td><td>${params.taux_actualisation}%</td></tr>
                        <tr><td>Type de compteur</td><td>${params.type_compteur.toUpperCase()}</td></tr>
                        <tr><td>Co√ªt compteur</td><td>${params.cout_compteur} $</td></tr>
                        <tr><td>Sc√©nario fuites</td><td>${params.scenario_fuites}</td></tr>
                        <tr><td>Sc√©nario adoption</td><td>${params.scenario_adoption}</td></tr>
                        <tr><td>Persistance</td><td>${params.persistance}</td></tr>
                        <tr><td>Mode analyse</td><td>${params.mode_economique ? '√âconomique' : 'Financier'}</td></tr>
                        <tr><td>Valeur eau</td><td>${params.valeur_sociale} $/m¬≥</td></tr>
                    </table>

                    <div class="footer">
                        Calculateur CBA Compteurs d'Eau - Mod√®le bas√© sur la m√©thodologie MAMH/SCT<br>
                        Les r√©sultats sont indicatifs et d√©pendent des hypoth√®ses utilis√©es.
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyPermalink() {
            const params = collectParams();
            const encoded = encodeURIComponent(btoa(JSON.stringify(params)));
            const link = `${location.origin}${location.pathname}?p=${encoded}`;
            navigator.clipboard.writeText(link);
            alert("Lien copi√© !");
        }

        // === Comparateur de sc√©narios ===
        function getSavedScenarios() {
            try {
                return JSON.parse(localStorage.getItem('savedScenarios') || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveScenariosToStorage(scenarios) {
            localStorage.setItem('savedScenarios', JSON.stringify(scenarios));
        }

        async function saveScenario() {
            const name = prompt("Nom du sc√©nario:", `Sc√©nario ${new Date().toLocaleTimeString('fr-CA')}`);
            if (!name) return;

            const params = collectParams();
            const result = await apiCall('/api/calculate', params);

            const scenario = {
                id: Date.now(),
                name: name,
                params: params,
                results: {
                    van: result.van,
                    rbc: result.rbc,
                    payback: result.payback,
                    investissement: result.investissement_initial
                },
                savedAt: new Date().toISOString()
            };

            const scenarios = getSavedScenarios();
            scenarios.push(scenario);
            saveScenariosToStorage(scenarios);

            updateComparatorUI();
            alert(`Sc√©nario "${name}" sauvegard√© !`);
        }

        function toggleComparator() {
            const panel = document.getElementById('comparator-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                updateComparatorUI();
            }
        }

        function updateComparatorUI() {
            const scenarios = getSavedScenarios();
            const listEl = document.getElementById('saved-scenarios-list');
            const tableEl = document.getElementById('comparison-table');
            const bodyEl = document.getElementById('comparison-body');

            if (scenarios.length === 0) {
                listEl.innerHTML = '<p style="color: #9ca3af;">Aucun sc√©nario sauvegard√©. Cliquez sur "Sauvegarder" pour ajouter le sc√©nario actuel.</p>';
                tableEl.style.display = 'none';
                return;
            }

            listEl.innerHTML = `<p style="color: #6b7280;">${scenarios.length} sc√©nario(s) sauvegard√©(s)</p>`;
            tableEl.style.display = 'block';

            bodyEl.innerHTML = scenarios.map(s => `
                <tr>
                    <td><strong>${s.name}</strong><br><span style="font-size: 10px; color: #9ca3af;">${new Date(s.savedAt).toLocaleString('fr-CA')}</span></td>
                    <td style="color: ${s.results.van >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${formatMoney(s.results.van)}</td>
                    <td>${s.results.rbc.toFixed(2)}</td>
                    <td>${s.results.payback ? s.results.payback.toFixed(1) + ' ans' : '>20'}</td>
                    <td>
                        <button onclick="loadScenario(${s.id})" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">Charger</button>
                        <button onclick="deleteScenario(${s.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 4px;">X</button>
                    </td>
                </tr>
            `).join('');
        }

        function loadScenario(id) {
            const scenarios = getSavedScenarios();
            const scenario = scenarios.find(s => s.id === id);
            if (scenario) {
                applyParamsToForm(scenario.params);
                alert(`Sc√©nario "${scenario.name}" charg√© !`);
            }
        }

        function deleteScenario(id) {
            if (!confirm("Supprimer ce sc√©nario ?")) return;
            const scenarios = getSavedScenarios().filter(s => s.id !== id);
            saveScenariosToStorage(scenarios);
            updateComparatorUI();
        }

        function clearSavedScenarios() {
            if (!confirm("Effacer tous les sc√©narios sauvegard√©s ?")) return;
            localStorage.removeItem('savedScenarios');
            updateComparatorUI();
        }

        function applyParamsToForm(params) {
            suppressParamChange = true;

            if (params.nb_menages != null) document.getElementById('nb-menages').value = params.nb_menages;
            if (params.taille_menage != null) document.getElementById('taille-menage').value = params.taille_menage;
            if (params.lpcd != null) document.getElementById('lpcd').value = params.lpcd;
            if (params.horizon != null) document.getElementById('horizon').value = params.horizon;
            if (params.taux_actualisation != null) document.getElementById('taux-actualisation').value = params.taux_actualisation;
            if (params.type_compteur) document.getElementById('type-compteur').value = params.type_compteur;
            if (params.cout_compteur != null) document.getElementById('cout-compteur').value = params.cout_compteur;
            if (params.heures_installation != null) document.getElementById('heures-install').value = params.heures_installation;
            if (params.taux_horaire != null) document.getElementById('taux-horaire').value = params.taux_horaire;
            if (params.cout_reseau != null) document.getElementById('cout-reseau').value = params.cout_reseau;
            if (params.cout_infra_fixe != null) document.getElementById('cout-infra-fixe').value = params.cout_infra_fixe;

            if (params.reduction_comportement != null) document.getElementById('reduction-comportement').value = params.reduction_comportement;
            if (params.persistance) document.getElementById('persistance').value = params.persistance;
            if (params.scenario_fuites) {
                const fuitesMap = {
                    "sans_cout": "standard",
                    "quebec_deux_stocks": "deux_stocks",
                    "quebec_deux_stocks_sans_tarif": "deux_stocks_sans_tarif",
                };
                const fuitesValue = fuitesMap[params.scenario_fuites] || params.scenario_fuites;
                document.getElementById('scenario-fuites').value = fuitesValue;
            }

            if (params.scenario_adoption) {
                const adoptionMap = { "progressif": "progressive", "secteur": "par_secteur" };
                const adoptionValue = adoptionMap[params.scenario_adoption] || params.scenario_adoption;
                document.getElementById('scenario-adoption').value = adoptionValue;
            }
            if (params.valeur_sociale != null) document.getElementById('valeur-sociale').value = params.valeur_sociale;
            if (params.cout_variable != null) document.getElementById('cout-variable').value = params.cout_variable;
            if (params.valeur_eau_preset) document.getElementById('valeur-eau-preset').value = params.valeur_eau_preset;
            if (params.activer_economies_echelle != null) document.getElementById('economies-echelle').checked = params.activer_economies_echelle;

            if (params.mode_economique != null) setModeEconomique(params.mode_economique);

            if (params.prevalence_petites_pct != null) document.getElementById('prevalence-petites').value = params.prevalence_petites_pct;
            if (params.debit_petites_m3 != null) document.getElementById('debit-petites').value = params.debit_petites_m3;
            if (params.prevalence_grosses_pct != null) document.getElementById('prevalence-grosses').value = params.prevalence_grosses_pct;
            if (params.debit_grosses_m3 != null) document.getElementById('debit-grosses').value = params.debit_grosses_m3;
            if (params.taux_detection_pct != null) document.getElementById('taux-detection').value = params.taux_detection_pct;
            if (params.taux_reparation_pct != null) document.getElementById('taux-reparation').value = params.taux_reparation_pct;
            if (params.facteur_detection_sig != null) document.getElementById('facteur-detection-sig').value = params.facteur_detection_sig;
            if (params.facteur_reparation_sig != null) document.getElementById('facteur-reparation-sig').value = params.facteur_reparation_sig;
            if (params.taux_nouvelles_fuites_pct != null) document.getElementById('nouvelles-fuites').value = params.taux_nouvelles_fuites_pct;
            if (params.part_persistantes_pct != null) document.getElementById('persistantes').value = params.part_persistantes_pct;
            if (params.facteur_duree_longue_traine != null) document.getElementById('longue-traine').value = params.facteur_duree_longue_traine;
            if (params.cout_reparation_petite != null) document.getElementById('cout-petite').value = params.cout_reparation_petite;
            if (params.cout_reparation_grosse != null) document.getElementById('cout-grosse').value = params.cout_reparation_grosse;
            if (params.part_ville_pct != null) document.getElementById('part-ville').value = params.part_ville_pct;
            if (params.inclure_cout_reparation != null) document.getElementById('inclure-couts').checked = params.inclure_cout_reparation;

            if (params.adoption_max_pct != null) document.getElementById('adoption-max').value = params.adoption_max_pct;
            if (params.adoption_k_vitesse != null) document.getElementById('adoption-k').value = params.adoption_k_vitesse;
            if (params.adoption_t0_point_median != null) document.getElementById('adoption-t0').value = params.adoption_t0_point_median;
            if (params.adoption_etaler_capex != null) document.getElementById('adoption-etaler-capex').checked = params.adoption_etaler_capex;

            if (params.reseau_activer != null) document.getElementById('reseau-activer').checked = params.reseau_activer;
            if (params.reseau_volume_pertes_m3_an != null) document.getElementById('reseau-volume').value = params.reseau_volume_pertes_m3_an;
            if (params.reseau_reduction_max_pct != null) document.getElementById('reseau-reduc-max').value = params.reseau_reduction_max_pct;
            if (params.reseau_mode_reduction) document.getElementById('reseau-mode').value = params.reseau_mode_reduction;
            if (params.reseau_annees_atteinte != null) document.getElementById('reseau-annees').value = params.reseau_annees_atteinte;
            if (params.reseau_pondere_par_adoption != null) document.getElementById('reseau-pondere').checked = params.reseau_pondere_par_adoption;

            if (params.mc_seed != null) document.getElementById('montecarlo-seed').value = params.mc_seed;
            if (params.mc_n_simulations != null) document.getElementById('montecarlo-sims').value = params.mc_n_simulations;

            const scenario = document.getElementById('scenario-fuites').value;
            const advancedFuites = document.getElementById('advanced-fuites');
            if (scenario === 'custom') {
                advancedFuites.style.display = 'block';
                document.getElementById('content-fuites').classList.add('open');
                document.getElementById('chevron-fuites').classList.add('open');
            } else {
                advancedFuites.style.display = 'none';
            }
            document.getElementById('tarification').checked = !isSansTarifScenario(scenario);

            const adoptionScenario = document.getElementById('scenario-adoption').value;
            document.getElementById('advanced-adoption').style.display = (adoptionScenario === "custom") ? "block" : "none";

            const reseauOn = document.getElementById('reseau-activer').checked;
            document.getElementById('advanced-reseau').style.display = reseauOn ? 'block' : 'none';

            suppressParamChange = false;
            updateLabels();
        }

        async function loadFromPermalink() {
            if (permalinkApplied) return false;
            const sp = new URLSearchParams(location.search);
            const p = sp.get("p");
            if (!p) return false;
            try {
                const params = JSON.parse(atob(decodeURIComponent(p)));
                permalinkApplied = true;
                applyParamsToForm(params);
                await updateModel();
                return true;
            } catch (e) {
                console.warn("Permalink invalide", e);
                return false;
            }
        }

        // ========================================
        // Map Picker Integration
        // ========================================

        function openMapPicker() {
            document.getElementById('map-modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeMapPicker() {
            document.getElementById('map-modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ========================================
        // Calibration Modal
        // ========================================
        let calibrationData = null;

        function openCalibrationModal() {
            document.getElementById('calibration-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            resetCalibration();
        }

        function closeCalibrationModal() {
            document.getElementById('calibration-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function resetCalibration() {
            calibrationData = null;
            document.getElementById('calibration-upload').style.display = 'block';
            document.getElementById('calibration-results').style.display = 'none';
            document.getElementById('csv-file-input').value = '';
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.target.style.borderColor = '#cbd5e1';
            const file = event.dataTransfer.files[0];
            if (file) processCSVFile(file);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processCSVFile(file);
        }

        async function processCSVFile(file) {
            try {
                const text = await file.text();
                const lines = text.trim().split('\n');
                const data = [];

                // Parser CSV simple
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(/[,;]/);
                    if (parts.length >= 2) {
                        data.push({
                            mois: parts[0].trim(),
                            consommation_m3: parseFloat(parts[1].trim())
                        });
                    }
                }

                if (data.length < 3) {
                    alert('Le fichier doit contenir au moins 3 mois de donn√©es.');
                    return;
                }

                // Appeler l'API de calibrage
                const nbMenages = parseInt(document.getElementById('nb-menages').value);
                const tailleMenage = parseFloat(document.getElementById('taille-menage').value);

                const result = await apiCall('/api/calibrate_from_data', {
                    data: data,
                    nb_menages: nbMenages,
                    taille_menage: tailleMenage
                });

                calibrationData = result;
                displayCalibrationResults(result);

            } catch (error) {
                console.error('Erreur calibrage:', error);
                alert('Erreur lors du traitement du fichier: ' + error.message);
            }
        }

        function displayCalibrationResults(result) {
            document.getElementById('calibration-upload').style.display = 'none';
            document.getElementById('calibration-results').style.display = 'block';

            // LPCD
            document.getElementById('calib-lpcd').textContent = Math.round(result.lpcd.valeur);
            document.getElementById('calib-lpcd-ic').textContent =
                `IC 95%: [${Math.round(result.lpcd.intervalle_confiance[0])}, ${Math.round(result.lpcd.intervalle_confiance[1])}]`;

            // Fuites
            document.getElementById('calib-fuites').textContent = result.fuites_estimees.prevalence_pct.toFixed(0) + '%';
            document.getElementById('calib-fuites-conf').textContent = 'Confiance: ' + result.fuites_estimees.confiance;

            // Statistiques
            document.getElementById('calib-mean').textContent = result.consommation_mensuelle.moyenne_m3.toLocaleString();
            document.getElementById('calib-cv').textContent = result.consommation_mensuelle.coef_variation.toFixed(3);
            document.getElementById('calib-variance').textContent = result.saisonnalite.variance_ratio.toFixed(2) + 'x';
            document.getElementById('calib-anomalies').textContent = result.anomalies.nombre;
        }

        function applyCalibration() {
            if (!calibrationData) return;

            // Appliquer LPCD
            const lpcdInput = document.getElementById('lpcd');
            lpcdInput.value = Math.round(calibrationData.lpcd.valeur);

            // Mettre √† jour l'interface
            updateLabels();
            onParamChange();
            closeCalibrationModal();

            // Notification
            alert(`Calibrage appliqu√©:\n- LPCD: ${Math.round(calibrationData.lpcd.valeur)} L/pers/jour\n- Qualit√© donn√©es: ${calibrationData.recommandations.qualite_donnees}`);
        }

        // Listen for municipality selection from the map iframe
        window.addEventListener('message', async function(event) {
            // Verify origin for security (adjust if needed)
            if (event.data && event.data.type === 'municipalitySelected') {
                const data = event.data.data;
                await loadFromMap(data);
                closeMapPicker();
            }
        });

        async function loadFromMap(data) {
            const name = data.name || 'Municipalit√©';
            // Support both old (census) and new (BIL) field names
            const households = data.nb_logements || data.households;
            const householdSize = data.pers_par_residence || data.household_size;
            const lpcd = data.lpcd;
            const population = data.population_desservie || data.population;

            // Calculate households from population if not available
            let nbMenages = households;
            if (!nbMenages && population && householdSize) {
                nbMenages = Math.round(population / householdSize);
            } else if (!nbMenages && population) {
                nbMenages = Math.round(population / 2.2); // Default household size
            }

            // Set values if available
            if (nbMenages && nbMenages >= 10000) {
                document.getElementById('nb-menages').value = Math.min(nbMenages, 1000000);
            } else if (nbMenages) {
                // For small municipalities, set minimum
                document.getElementById('nb-menages').value = 10000;
            }

            if (householdSize) {
                document.getElementById('taille-menage').value = Math.min(Math.max(householdSize, 1.5), 4);
            }

            if (lpcd) {
                document.getElementById('lpcd').value = Math.min(Math.max(lpcd, 150), 450);
            }

            // Clear active presets
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));

            // Show selected municipality
            const selectedEl = document.getElementById('selected-municipality');
            if (selectedEl) {
                selectedEl.innerHTML = `<i data-lucide="map-pin" class="lucide-sm"></i> <strong>${name}</strong> s√©lectionn√©e${population ? ` (${Math.round(population).toLocaleString('fr-CA')} hab. desservis)` : ''}`;
                selectedEl.classList.add('active');
                lucide.createIcons();
            }

            updateLabels();
            await updateModel();
        }

        window.addEventListener("load", () => {
            lucide.createIcons();
            loadFromPermalink();
        });
    </script>

    <!-- Map Modal -->
    <div class="map-modal-overlay" id="map-modal-overlay" onclick="if(event.target === this) closeMapPicker()">
        <div class="map-modal">
            <div class="map-modal-header">
                <div>
                    <div class="map-modal-title" data-i18n="map.title">S√©lectionner une municipalit√©</div>
                    <div class="map-modal-subtitle" data-i18n="map.subtitle">Cliquez sur une municipalit√© pour charger ses donn√©es</div>
                </div>
                <button class="map-modal-close" onclick="closeMapPicker()"><i data-lucide="x"></i></button>
            </div>
            <div class="map-modal-body">
                <iframe src="map/index.html" id="map-iframe"></iframe>
            </div>
            <div class="map-modal-footer" data-i18n="map.data_source">
                Donn√©es: BIL 2023 (MAMH) ‚Ä¢ Statistique Canada Recensement 2021
            </div>
        </div>
    </div>

    <!-- Modal Calibrage -->
    <div class="map-modal-overlay" id="calibration-modal" onclick="if(event.target === this) closeCalibrationModal()">
        <div class="map-modal" style="max-width: 600px;">
            <div class="map-modal-header">
                <div>
                    <div class="map-modal-title"><i data-lucide="sliders-horizontal" class="lucide-md"></i> <span data-i18n="calibration.title">Assistant de calibrage</span></div>
                    <div class="map-modal-subtitle" data-i18n="calibration.subtitle">Importer des donn√©es de consommation pour calibrer les param√®tres</div>
                </div>
                <button class="map-modal-close" onclick="closeCalibrationModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="map-modal-body" style="padding: 20px; height: auto; max-height: 70vh; overflow-y: auto;">
                <!-- Zone d'import -->
                <div id="calibration-upload" style="margin-bottom: 20px;">
                    <div style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer;"
                         onclick="document.getElementById('csv-file-input').click()"
                         ondragover="this.style.borderColor='#3b82f6'; event.preventDefault()"
                         ondragleave="this.style.borderColor='#cbd5e1'"
                         ondrop="handleFileDrop(event)">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <div style="font-weight: 600; color: #374151;" data-i18n="calibration.drop_file">Glisser un fichier CSV ici</div>
                        <div style="color: #6b7280; font-size: 13px; margin-top: 5px;" data-i18n="calibration.or_click">ou cliquer pour s√©lectionner</div>
                        <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #f1f5f9; border-radius: 8px;">
                        <div style="font-weight: 600; font-size: 12px; color: #475569; margin-bottom: 8px;" data-i18n="calibration.format">Format attendu (CSV):</div>
                        <code style="font-size: 11px; color: #64748b;">mois,consommation_m3<br>2024-01,125000<br>2024-02,118000<br>...</code>
                    </div>
                </div>

                <!-- R√©sultats calibrage -->
                <div id="calibration-results" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 11px; color: #166534; font-weight: 600;" data-i18n="calibration.lpcd_suggested">LPCD sugg√©r√©</div>
                            <div style="font-size: 28px; font-weight: 700; color: #15803d;" id="calib-lpcd">‚Äî</div>
                            <div style="font-size: 10px; color: #22c55e;" id="calib-lpcd-ic">IC 95%: [‚Äî, ‚Äî]</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 11px; color: #92400e; font-weight: 600;" data-i18n="calibration.leak_prevalence">Pr√©valence fuites</div>
                            <div style="font-size: 28px; font-weight: 700; color: #d97706;" id="calib-fuites">‚Äî%</div>
                            <div style="font-size: 10px; color: #f59e0b;" id="calib-fuites-conf"><span data-i18n="calibration.confidence">Confiance:</span> ‚Äî</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-weight: 600; font-size: 12px; color: #334155; margin-bottom: 8px;" data-i18n="calibration.stats">Statistiques des donn√©es</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px;">
                            <div><span data-i18n="calibration.mean">Consommation moyenne:</span> <strong id="calib-mean">‚Äî</strong> m¬≥/mois</div>
                            <div><span data-i18n="calibration.cv">Coefficient variation:</span> <strong id="calib-cv">‚Äî</strong></div>
                            <div><span data-i18n="calibration.seasonality">Variance saisonni√®re:</span> <strong id="calib-variance">‚Äî</strong></div>
                            <div><span data-i18n="calibration.anomalies">Anomalies d√©tect√©es:</span> <strong id="calib-anomalies">‚Äî</strong></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn" style="flex: 1;" onclick="applyCalibration()"><i data-lucide="check" class="lucide-sm"></i> <span data-i18n="calibration.apply">Appliquer les valeurs</span></button>
                        <button class="btn" style="flex: 1; background: #f1f5f9; color: #475569;" onclick="resetCalibration()" data-i18n="calibration.reset">R√©initialiser</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
